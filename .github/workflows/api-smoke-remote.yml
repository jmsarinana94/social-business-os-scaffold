name: API Smoke (remote)

on:
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest

    env:
      API_BASE: ${{ secrets.API_BASE }}
      API_EMAIL: ${{ secrets.API_EMAIL }}
      API_PASS: ${{ secrets.API_PASS }}
      API_ORG: ${{ secrets.API_ORG || 'demo' }}

    steps:
      - name: Check out
        uses: actions/checkout@v6

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y direnv jq curl make

      - name: Allow direnv (apps/api) and create .envrc.local
        working-directory: apps/api
        run: |
          direnv allow
          cat > .envrc.local <<EOF
          export API_EMAIL="${API_EMAIL}"
          export API_PASS="${API_PASS}"
          export BASE="${API_BASE}"
          export ORG="${API_ORG}"
          EOF

      - name: Wait for remote API health
        run: |
          echo "Waiting for ${API_BASE}/health â€¦"
          for i in $(seq 1 60); do
            if curl -fsS "${API_BASE}/health" >/dev/null; then
              echo "API is up."
              exit 0
            fi
            sleep 2
          done
          echo "Remote API not healthy." >&2
          exit 1

      - name: Env sanity
        run: make api.env

      - name: Login
        run: make api.login

      - name: Products list
        run: make api.products

      - name: Smoke test
        run: make api.smoke
