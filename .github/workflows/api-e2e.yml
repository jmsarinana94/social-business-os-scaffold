# .github/workflows/api-e2e.yml
name: API E2E Tests

on:
  pull_request:
    branches: ["**"]
  push:
    branches: ["**"]

jobs:
  e2e:
    runs-on: ubuntu-24.04
    env:
      NODE_ENV: test
      # keep your sqlite path so runs are hermetic
      DATABASE_URL: file:./apps/api/prisma/dev.db
      # your existing flag from logs
      E2E_AUTO_CREATE_ORG: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup pnpm (reads version from package.json > packageManager)
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: |
            pnpm-lock.yaml
            **/pnpm-lock.yaml

      - name: Verify tooling
        run: |
          node -v
          pnpm -v

      - name: Install deps
        run: pnpm install --frozen-lockfile

      # Ensure sqlite file/dir exists (harmless if already created by Prisma)
      - name: Prepare sqlite file
        run: |
          mkdir -p apps/api/prisma
          : > apps/api/prisma/dev.db

      - name: Prisma generate (best-effort)
        run: |
          pnpm -w -r --if-present exec prisma generate

      # If you use Playwright for E2E, install browsers (no-op if not present)
      - name: Install Playwright (best-effort)
        run: |
          pnpm -w -r --if-present exec playwright install --with-deps

      - name: Run E2E tests
        run: |
          # try common script names, succeed if any exists
          pnpm -w -r --if-present run e2e || \
          pnpm -w -r --if-present run test:e2e