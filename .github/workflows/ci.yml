name: CI
on:
  push: { branches: [ main ] }
  pull_request: { branches: [ main ] }
jobs:
  api:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: sbo
          POSTGRES_PASSWORD: sbo
          POSTGRES_DB: sbo
        ports: [ '5432:5432' ]
        options: >-
          --health-cmd="pg_isready -U sbo" --health-interval=10s --health-timeout=5s --health-retries=5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - name: Enable Corepack
        run: corepack enable && corepack prepare pnpm@9.12.2 --activate
      - name: Install deps
        run: pnpm install --frozen-lockfile
      - name: Set DATABASE_URL
        run: echo "DATABASE_URL=postgresql://sbo:sbo@localhost:5432/sbo" >> $GITHUB_ENV
      - name: Generate Prisma Client
        run: pnpm -w -F @repo/api prisma generate
      - name: DB Push
        run: pnpm -w -F @repo/api prisma db push
      - name: Build
        run: pnpm -w -F @repo/api build
      - name: Test e2e
        run: pnpm -w -F @repo/api test:e2e