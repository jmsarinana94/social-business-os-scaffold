name: API Smoke

on:
  push:
  pull_request:

jobs:
  smoke:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node (for the API container build cache, not required locally)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system deps (jq, curl, direnv)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl direnv

      - name: Create .envrc.local for apps/api
        run: |
          cat > apps/api/.envrc.local <<'EOF'
          export BASE="http://localhost:4000"
          export ORG="demo"
          # These credentials are used by smoke.sh to log in
          export API_EMAIL="tester@example.com"
          export API_PASS="password"
          EOF

      - name: Boot Postgres + API (Docker Compose)
        run: |
          docker compose -f docker-compose.yml up -d --build
          echo "Waiting for API to become healthy..."
          for i in {1..60}; do
            if curl -sSf http://localhost:4000/health >/dev/null 2>&1; then
              echo "API is healthy."
              break
            fi
            sleep 2
          done

      - name: Show env sanity
        run: make api.env

      - name: Run smoke test
        run: make api.smoke

      - name: Docker logs (if failing)
        if: failure()
        run: |
          docker compose -f docker-compose.yml ps
          docker compose -f docker-compose.yml logs --no-color --tail=300 api db
