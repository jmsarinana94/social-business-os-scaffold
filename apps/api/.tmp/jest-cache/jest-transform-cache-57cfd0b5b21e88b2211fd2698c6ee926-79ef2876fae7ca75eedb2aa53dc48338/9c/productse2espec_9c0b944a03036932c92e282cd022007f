1e6ceafbb9263c9eeec839cf2f597aae
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
// apps/api/test/products.e2e-spec.ts
require("reflect-metadata");
const common_1 = require("@nestjs/common");
const testing_1 = require("@nestjs/testing");
const client_1 = require("@prisma/client");
const supertest_1 = __importDefault(require("supertest"));
const app_module_1 = require("../src/app.module");
const prisma_exception_filter_1 = require("../src/common/filters/prisma-exception.filter");
const prisma = new client_1.PrismaClient();
const ORG_SLUG = process.env.TEST_ORG ?? 'demo';
describe('Products (e2e)', () => {
    let app;
    beforeAll(async () => {
        // reset DB
        await prisma.$executeRawUnsafe('TRUNCATE TABLE "Product" RESTART IDENTITY CASCADE;');
        await prisma.$executeRawUnsafe('TRUNCATE TABLE "Organization" RESTART IDENTITY CASCADE;');
        // seed org
        await prisma.organization.create({
            data: { slug: ORG_SLUG, name: ORG_SLUG.toUpperCase() },
        });
        const moduleRef = await testing_1.Test.createTestingModule({
            imports: [app_module_1.AppModule],
        }).compile();
        app = moduleRef.createNestApplication();
        app.useGlobalPipes(new common_1.ValidationPipe({ whitelist: true, transform: true }));
        app.useGlobalFilters(new prisma_exception_filter_1.PrismaExceptionFilter());
        await app.init();
    });
    afterAll(async () => {
        await app.close();
        await prisma.$disconnect();
    });
    it('health', async () => {
        const res = await (0, supertest_1.default)(app.getHttpServer()).get('/health').expect(200);
        expect(res.body?.ok).toBe(true);
    });
    it('create/list/get/update/delete product', async () => {
        const agent = (0, supertest_1.default)(app.getHttpServer());
        const headers = { 'x-org': ORG_SLUG, 'content-type': 'application/json' };
        // create
        const createRes = await agent
            .post('/products')
            .set(headers)
            .send({ title: 'Widget', type: 'physical', status: 'active', price: 12, description: 'Test' })
            .expect(201);
        const id = createRes.body.id ?? createRes.body.data?.id;
        expect(id).toBeTruthy();
        // get
        const getRes = await agent.get(`/products/${id}`).set({ 'x-org': ORG_SLUG }).expect(200);
        expect(getRes.body.title).toEqual('Widget');
        // update
        const updRes = await agent
            .put(`/products/${id}`)
            .set(headers)
            .send({ title: 'Widget (updated)', price: 19 })
            .expect(200);
        expect(updRes.body.title).toEqual('Widget (updated)');
        // list
        const listRes = await agent.get('/products?page=1&limit=5').set({ 'x-org': ORG_SLUG }).expect(200);
        expect(Array.isArray(listRes.body.data)).toBe(true);
        expect(listRes.body.meta?.page).toBe(1);
        // delete
        await agent.delete(`/products/${id}`).set({ 'x-org': ORG_SLUG }).expect(200);
        await agent.get(`/products/${id}`).set({ 'x-org': ORG_SLUG }).expect(404);
    });
    it('rejects missing x-org', async () => {
        await (0, supertest_1.default)(app.getHttpServer()).get('/products').expect(400);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hbm55c2FyaW5hbmEvRG93bmxvYWRzL3NvY2lhbC1idXNpbmVzcy1vcy1zY2FmZm9sZC12MC4yL2FwcHMvYXBpL3Rlc3QvcHJvZHVjdHMuZTJlLXNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxxQ0FBcUM7QUFDckMsNEJBQTBCO0FBRTFCLDJDQUFrRTtBQUNsRSw2Q0FBdUM7QUFDdkMsMkNBQThDO0FBQzlDLDBEQUFnQztBQUVoQyxrREFBOEM7QUFDOUMsMkZBQXNGO0FBRXRGLE1BQU0sTUFBTSxHQUFHLElBQUkscUJBQVksRUFBRSxDQUFDO0FBQ2xDLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxJQUFJLE1BQU0sQ0FBQztBQUVoRCxRQUFRLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFO0lBQzlCLElBQUksR0FBcUIsQ0FBQztJQUUxQixTQUFTLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDbkIsV0FBVztRQUNYLE1BQU0sTUFBTSxDQUFDLGlCQUFpQixDQUFDLG9EQUFvRCxDQUFDLENBQUM7UUFDckYsTUFBTSxNQUFNLENBQUMsaUJBQWlCLENBQUMseURBQXlELENBQUMsQ0FBQztRQUUxRixXQUFXO1FBQ1gsTUFBTSxNQUFNLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQztZQUMvQixJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsV0FBVyxFQUFFLEVBQUU7U0FDdkQsQ0FBQyxDQUFDO1FBRUgsTUFBTSxTQUFTLEdBQUcsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDL0MsT0FBTyxFQUFFLENBQUMsc0JBQVMsQ0FBQztTQUNyQixDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFYixHQUFHLEdBQUcsU0FBUyxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFDeEMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxJQUFJLHVCQUFjLENBQUMsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLFNBQVMs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Q0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BELE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFeEMsU0FBUztRQUNULE1BQU0sS0FBSyxDQUFDLE1BQU0sQ0FBQyxhQUFhLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzdFLE1BQU0sS0FBSyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzVFLENBQUMsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLHVCQUF1QixFQUFFLEtBQUssSUFBSSxFQUFFO1FBQ3JDLE1BQU0sSUFBQSxtQkFBTyxFQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDbEUsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWFubnlzYXJpbmFuYS9Eb3dubG9hZHMvc29jaWFsLWJ1c2luZXNzLW9zLXNjYWZmb2xkLXYwLjIvYXBwcy9hcGkvdGVzdC9wcm9kdWN0cy5lMmUtc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBhcHBzL2FwaS90ZXN0L3Byb2R1Y3RzLmUyZS1zcGVjLnRzXG5pbXBvcnQgJ3JlZmxlY3QtbWV0YWRhdGEnO1xuXG5pbXBvcnQgeyBJTmVzdEFwcGxpY2F0aW9uLCBWYWxpZGF0aW9uUGlwZSB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFRlc3QgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnO1xuaW1wb3J0IHsgUHJpc21hQ2xpZW50IH0gZnJvbSAnQHByaXNtYS9jbGllbnQnO1xuaW1wb3J0IHJlcXVlc3QgZnJvbSAnc3VwZXJ0ZXN0JztcblxuaW1wb3J0IHsgQXBwTW9kdWxlIH0gZnJvbSAnLi4vc3JjL2FwcC5tb2R1bGUnO1xuaW1wb3J0IHsgUHJpc21hRXhjZXB0aW9uRmlsdGVyIH0gZnJvbSAnLi4vc3JjL2NvbW1vbi9maWx0ZXJzL3ByaXNtYS1leGNlcHRpb24uZmlsdGVyJztcblxuY29uc3QgcHJpc21hID0gbmV3IFByaXNtYUNsaWVudCgpO1xuY29uc3QgT1JHX1NMVUcgPSBwcm9jZXNzLmVudi5URVNUX09SRyA/PyAnZGVtbyc7XG5cbmRlc2NyaWJlKCdQcm9kdWN0cyAoZTJlKScsICgpID0+IHtcbiAgbGV0IGFwcDogSU5lc3RBcHBsaWNhdGlvbjtcblxuICBiZWZvcmVBbGwoYXN5bmMgKCkgPT4ge1xuICAgIC8vIHJlc2V0IERCXG4gICAgYXdhaXQgcHJpc21hLiRleGVjdXRlUmF3VW5zYWZlKCdUUlVOQ0FURSBUQUJMRSBcIlByb2R1Y3RcIiBSRVNUQVJUIElERU5USVRZIENBU0NBREU7Jyk7XG4gICAgYXdhaXQgcHJpc21hLiRleGVjdXRlUmF3VW5zYWZlKCdUUlVOQ0FURSBUQUJMRSBcIk9yZ2FuaXphdGlvblwiIFJFU1RBUlQgSURFTlRJVFkgQ0FTQ0FERTsnKTtcblxuICAgIC8vIHNlZWQgb3JnXG4gICAgYXdhaXQgcHJpc21hLm9yZ2FuaXphdGlvbi5jcmVhdGUoe1xuICAgICAgZGF0YTogeyBzbHVnOiBPUkdfU0xVRywgbmFtZTogT1JHX1NMVUcudG9VcHBlckNhc2UoKSB9LFxuICAgIH0pO1xuXG4gICAgY29uc3QgbW9kdWxlUmVmID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIGltcG9ydHM6IFtBcHBNb2R1bGVdLFxuICAgIH0pLmNvbXBpbGUoKTtcblxuICAgIGFwcCA9IG1vZHVsZVJlZi5jcmVhdGVOZXN0QXBwbGljYXRpb24oKTtcbiAgICBhcHAudXNlR2xvYmFsUGlwZXMobmV3IFZhbGlkYXRpb25QaXBlKHsgd2hpdGVsaXN0OiB0cnVlLCB0cmFuc2Zvcm06IHRydWUgfSkpO1xuICAgIGFwcC51c2VHbG9iYWxGaWx0ZXJzKG5ldyBQcmlzbWFFeGNlcHRpb25GaWx0ZXIoKSk7XG4gICAgYXdhaXQgYXBwLmluaXQoKTtcbiAgfSk7XG5cbiAgYWZ0ZXJBbGwoYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IGFwcC5jbG9zZSgpO1xuICAgIGF3YWl0IHByaXNtYS4kZGlzY29ubmVjdCgpO1xuICB9KTtcblxuICBpdCgnaGVhbHRoJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlcXVlc3QoYXBwLmdldEh0dHBTZXJ2ZXIoKSkuZ2V0KCcvaGVhbHRoJykuZXhwZWN0KDIwMCk7XG4gICAgZXhwZWN0KHJlcy5ib2R5Py5vaykudG9CZSh0cnVlKTtcbiAgfSk7XG5cbiAgaXQoJ2NyZWF0ZS9saXN0L2dldC91cGRhdGUvZGVsZXRlIHByb2R1Y3QnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgYWdlbnQgPSByZXF1ZXN0KGFwcC5nZXRIdHRwU2VydmVyKCkpO1xuICAgIGNvbnN0IGhlYWRlcnMgPSB7ICd4LW9yZyc6IE9SR19TTFVHLCAnY29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH07XG5cbiAgICAvLyBjcmVhdGVcbiAgICBjb25zdCBjcmVhdGVSZXMgPSBhd2FpdCBhZ2VudFxuICAgICAgLnBvc3QoJy9wcm9kdWN0cycpXG4gICAgICAuc2V0KGhlYWRlcnMpXG4gICAgICAuc2VuZCh7IHRpdGxlOiAnV2lkZ2V0JywgdHlwZTogJ3BoeXNpY2FsJywgc3RhdHVzOiAnYWN0aXZlJywgcHJpY2U6IDEyLCBkZXNjcmlwdGlvbjogJ1Rlc3QnIH0pXG4gICAgICAuZXhwZWN0KDIwMSk7XG5cbiAgICBjb25zdCBpZCA9IGNyZWF0ZVJlcy5ib2R5LmlkID8/IGNyZWF0ZVJlcy5ib2R5LmRhdGE/LmlkO1xuICAgIGV4cGVjdChpZCkudG9CZVRydXRoeSgpO1xuXG4gICAgLy8gZ2V0XG4gICAgY29uc3QgZ2V0UmVzID0gYXdhaXQgYWdlbnQuZ2V0KGAvcHJvZHVjdHMvJHtpZH1gKS5zZXQoeyAneC1vcmcnOiBPUkdfU0xVRyB9KS5leHBlY3QoMjAwKTtcbiAgICBleHBlY3QoZ2V0UmVzLmJvZHkudGl0bGUpLnRvRXF1YWwoJ1dpZGdldCcpO1xuXG4gICAgLy8gdXBkYXRlXG4gICAgY29uc3QgdXBkUmVzID0gYXdhaXQgYWdlbnRcbiAgICAgIC5wdXQoYC9wcm9kdWN0cy8ke2lkfWApXG4gICAgICAuc2V0KGhlYWRlcnMpXG4gICAgICAuc2VuZCh7IHRpdGxlOiAnV2lkZ2V0ICh1cGRhdGVkKScsIHByaWNlOiAxOSB9KVxuICAgICAgLmV4cGVjdCgyMDApO1xuICAgIGV4cGVjdCh1cGRSZXMuYm9keS50aXRsZSkudG9FcXVhbCgnV2lkZ2V0ICh1cGRhdGVkKScpO1xuXG4gICAgLy8gbGlzdFxuICAgIGNvbnN0IGxpc3RSZXMgPSBhd2FpdCBhZ2VudC5nZXQoJy9wcm9kdWN0cz9wYWdlPTEmbGltaXQ9NScpLnNldCh7ICd4LW9yZyc6IE9SR19TTFVHIH0pLmV4cGVjdCgyMDApO1xuICAgIGV4cGVjdChBcnJheS5pc0FycmF5KGxpc3RSZXMuYm9keS5kYXRhKSkudG9CZSh0cnVlKTtcbiAgICBleHBlY3QobGlzdFJlcy5ib2R5Lm1ldGE/LnBhZ2UpLnRvQmUoMSk7XG5cbiAgICAvLyBkZWxldGVcbiAgICBhd2FpdCBhZ2VudC5kZWxldGUoYC9wcm9kdWN0cy8ke2lkfWApLnNldCh7ICd4LW9yZyc6IE9SR19TTFVHIH0pLmV4cGVjdCgyMDApO1xuICAgIGF3YWl0IGFnZW50LmdldChgL3Byb2R1Y3RzLyR7aWR9YCkuc2V0KHsgJ3gtb3JnJzogT1JHX1NMVUcgfSkuZXhwZWN0KDQwNCk7XG4gIH0pO1xuXG4gIGl0KCdyZWplY3RzIG1pc3NpbmcgeC1vcmcnLCBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKS5nZXQoJy9wcm9kdWN0cycpLmV4cGVjdCg0MDApO1xuICB9KTtcbn0pOyJdLCJ2ZXJzaW9uIjozfQ==