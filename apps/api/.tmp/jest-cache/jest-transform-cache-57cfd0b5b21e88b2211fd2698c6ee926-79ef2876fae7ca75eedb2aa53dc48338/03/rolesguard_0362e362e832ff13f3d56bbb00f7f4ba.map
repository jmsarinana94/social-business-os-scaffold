{"file":"/Users/mannysarinana/Downloads/social-business-os-scaffold-v0.2/apps/api/src/common/guards/roles.guard.ts","mappings":";;;;;;;;;;;;AAAA,2CAA+F;AAC/F,uCAAyC;AACzC,gEAAuD;AACvD,sEAAkE;AAG3D,IAAM,UAAU,GAAhB,MAAM,UAAU;IACrB,YAAoB,SAAoB,EAAU,MAAqB;QAAnD,cAAS,GAAT,SAAS,CAAW;QAAU,WAAM,GAAN,MAAM,CAAe;IAAG,CAAC;IAE3E,KAAK,CAAC,WAAW,CAAC,GAAqB;QACrC,MAAM,QAAQ,GAAG,IAAI,CAAC,SAAS,CAAC,iBAAiB,CAAW,2BAAS,EAAE;YACrE,GAAG,CAAC,UAAU,EAAE;YAChB,GAAG,CAAC,QAAQ,EAAE;SACf,CAAC,IAAI,EAAE,CAAC;QAET,IAAI,QAAQ,CAAC,MAAM,KAAK,CAAC;YAAE,OAAO,IAAI,CAAC;QAEvC,MAAM,GAAG,GAAG,GAAG,CAAC,YAAY,EAAE,CAAC,UAAU,EAAE,CAAC;QAC5C,MAAM,MAAM,GAAG,GAAG,CAAC,IAAI,EAAE,GAAG,CAAC;QAC7B,MAAM,KAAK,GAAG,GAAG,CAAC,OAAO,CAAC,OAAO,CAAuB,CAAC;QAEzD,IAAI,CAAC,MAAM,IAAI,CAAC,KAAK;YAAE,MAAM,IAAI,2BAAkB,CAAC,qBAAqB,CAAC,CAAC;QAE3E,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,SAAS,CAAC,EAAE,KAAK,EAAE,EAAE,KAAK,EAAE,MAAM,EAAE,EAAE,CAAC,CAAC;QACnF,IAAI,CAAC,MAAM;YAAE,MAAM,IAAI,2BAAkB,CAAC,0BAA0B,CAAC,CAAC;QACtE,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC;YAAE,MAAM,IAAI,2BAAkB,CAAC,mBAAmB,CAAC,CAAC;QAEvF,OAAO,IAAI,CAAC;IACd,CAAC;CACF,CAAA;AAvBY,gCAAU;qBAAV,UAAU;IADtB,IAAA,mBAAU,GAAE;qCAEoB,gBAAS,EAAkB,8BAAa;GAD5D,UAAU,CAuBtB","names":[],"sources":["/Users/mannysarinana/Downloads/social-business-os-scaffold-v0.2/apps/api/src/common/guards/roles.guard.ts"],"sourcesContent":["import { CanActivate, ExecutionContext, ForbiddenException, Injectable } from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\nimport { ROLES_KEY } from '../../auth/roles.decorator';\nimport { PrismaService } from '../../infra/prisma/prisma.service';\n\n@Injectable()\nexport class RolesGuard implements CanActivate {\n  constructor(private reflector: Reflector, private prisma: PrismaService) {}\n\n  async canActivate(ctx: ExecutionContext): Promise<boolean> {\n    const required = this.reflector.getAllAndOverride<string[]>(ROLES_KEY, [\n      ctx.getHandler(),\n      ctx.getClass(),\n    ]) || [];\n\n    if (required.length === 0) return true;\n\n    const req = ctx.switchToHttp().getRequest();\n    const userId = req.user?.sub;\n    const orgId = req.headers['x-org'] as string | undefined;\n\n    if (!userId || !orgId) throw new ForbiddenException('Missing user or org');\n\n    const member = await this.prisma.orgMember.findFirst({ where: { orgId, userId } });\n    if (!member) throw new ForbiddenException('Not a member of this org');\n    if (!required.includes(member.role)) throw new ForbiddenException('Insufficient role');\n\n    return true;\n  }\n}"],"version":3}