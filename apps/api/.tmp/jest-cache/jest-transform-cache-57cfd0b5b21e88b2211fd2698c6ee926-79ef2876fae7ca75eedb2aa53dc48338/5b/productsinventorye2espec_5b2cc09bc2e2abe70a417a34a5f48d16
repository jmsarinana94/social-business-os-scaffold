6fd95892fc0695a9b198f550f9b07e7b
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
// apps/api/test/e2e/products.inventory.e2e-spec.ts
const app_module_1 = require("@/app.module");
const testing_1 = require("@nestjs/testing");
const supertest_1 = __importDefault(require("supertest"));
describe('Products inventory (e2e)', () => {
    let app;
    const ORG = process.env.ORG || 'demo';
    const EMAIL = process.env.API_EMAIL || 'tester@example.com';
    const PASS = process.env.API_PASS || 'password123';
    beforeAll(async () => {
        const moduleRef = await testing_1.Test.createTestingModule({
            imports: [app_module_1.AppModule],
        }).compile();
        app = moduleRef.createNestApplication();
        await app.init();
    });
    afterAll(async () => {
        await app.close();
    });
    it('lists products and adjusts inventory +5, then rejects negative overshoot', async () => {
        // login (API returns 200 OK for login)
        const login = await (0, supertest_1.default)(app.getHttpServer())
            .post('/auth/login')
            .set('x-org', ORG)
            .send({ email: EMAIL, password: PASS })
            .expect(200);
        const token = login.body?.access_token;
        expect(token).toBeTruthy();
        const auth = { Authorization: `Bearer ${token}`, 'x-org': ORG };
        // get products
        const list = await (0, supertest_1.default)(app.getHttpServer())
            .get('/products')
            .set(auth)
            .expect(200);
        const product = list.body?.data?.[0];
        expect(product?.id).toBeTruthy();
        // adjust +5 (API returns 201 Created)
        const up = await (0, supertest_1.default)(app.getHttpServer())
            .post(`/products/${product.id}/inventory`)
            .set(auth)
            .send({ delta: 5 })
            .expect(201);
        expect(up.body?.inventoryQty).toBe(product.inventoryQty + 5);
        // negative guard: try to drop below zero -> 400
        const currentQty = up.body?.inventoryQty ?? 0;
        const overshoot = -(currentQty + 1);
        await (0, supertest_1.default)(app.getHttpServer())
            .post(`/products/${product.id}/inventory`)
            .set(auth)
            .send({ delta: overshoot })
            .expect(400);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hbm55c2FyaW5hbmEvRG93bmxvYWRzL3NvY2lhbC1idXNpbmVzcy1vcy1zY2FmZm9sZC12MC4yL2FwcHMvYXBpL3Rlc3QvZTJlL3Byb2R1Y3RzLmludmVudG9yeS5lMmUtc3BlYy50cyIsIm1hcHBpbmdzIjoiOzs7OztBQUFBLG1EQUFtRDtBQUNuRCw2Q0FBeUM7QUFFekMsNkNBQXVDO0FBQ3ZDLDBEQUFnQztBQUVoQyxRQUFRLENBQUMsMEJBQTBCLEVBQUUsR0FBRyxFQUFFO0lBQ3hDLElBQUksR0FBcUIsQ0FBQztJQUMxQixNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxNQUFNLENBQUM7SUFDdEMsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLElBQUksb0JBQW9CLENBQUM7SUFDNUQsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLElBQUksYUFBYSxDQUFDO0lBRW5ELFNBQVMsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNuQixNQUFNLFNBQVMsR0FBRyxNQUFNLGNBQUksQ0FBQyxtQkFBbUIsQ0FBQztZQUMvQyxPQUFPLEVBQUUsQ0FBQyxzQkFBUyxDQUFDO1NBQ3JCLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUViLEdBQUcsR0FBRyxTQUFTLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUN4QyxNQUFNLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNuQixDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNsQixNQUFNLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNwQixDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQywwRUFBMEUsRUFBRSxLQUFLLElBQUksRUFBRTtRQUN4Rix1Q0FBdUM7UUFDdkMsTUFBTSxLQUFLLEdBQUcsTUFBTSxJQUFBLG1CQUFPLEVBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxDQUFDO2FBQzdDLElBQUksQ0FBQyxhQUFhLENBQUM7YUFDbkIsR0FBRyxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUM7YUFDakIsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLENBQUM7YUFDdEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWYsTUFBTSxLQUFLLEdBQVcsS0FBSyxDQUFDLElBQUksRUFBRSxZQUFZLENBQUM7UUFDL0MsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBRTNCLE1BQU0sSUFBSSxHQUFHLEVBQUUsYUFBYSxFQUFFLFVBQVUsS0FBSyxFQUFFLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDO1FBRWhFLGVBQWU7UUFDZixNQUFNLElBQUksR0FBRyxNQUFNLElBQUEsbUJBQU8sRUFBQyxHQUFHLENBQUMsYUFBYSxFQUFFLENBQUM7YUFDNUMsR0FBRyxDQUFDLFdBQVcsQ0FBQzthQUNoQixHQUFHLENBQUMsSUFBSSxDQUFDO2FBQ1QsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWYsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNyQyxNQUFNLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBRWpDLHNDQUFzQztRQUN0QyxNQUFNLEVBQUUsR0FBRyxNQUFNLElBQUEsbUJBQU8sRUFBQyxHQUFHLENBQUMsYUFBYSxFQUFFLENBQUM7YUFDMUMsSUFBSSxDQUFDLGFBQWEsT0FBTyxDQUFDLEVBQUUsWUFBWSxDQUFDO2FBQ3pDLEdBQUcsQ0FBQyxJQUFJLENBQUM7YUFDVCxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUM7YUFDbEIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWYsTUFBTSxDQUFDLEVBQUUsQ0FBQyxJQUFJLEVBQUUsWUFBWSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFFN0QsZ0RBQWdEO1FBQ2hELE1BQU0sVUFBVSxHQUFXLEVBQUUsQ0FBQyxJQUFJLEVBQUUsWUFBWSxJQUFJLENBQUMsQ0FBQztRQUN0RCxNQUFNLFNBQVMsR0FBRyxDQUFDLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBRXBDLE1BQU0sSUFBQSxtQkFBTyxFQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsQ0FBQzthQUMvQixJQUFJLENBQUMsYUFBYSxPQUFPLENBQUMsRUFBRSxZQUFZLENBQUM7YUFDekMsR0FBRyxDQUFDLElBQUksQ0FBQzthQUNULElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsQ0FBQzthQUMxQixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDakIsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWFubnlzYXJpbmFuYS9Eb3dubG9hZHMvc29jaWFsLWJ1c2luZXNzLW9zLXNjYWZmb2xkLXYwLjIvYXBwcy9hcGkvdGVzdC9lMmUvcHJvZHVjdHMuaW52ZW50b3J5LmUyZS1zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIGFwcHMvYXBpL3Rlc3QvZTJlL3Byb2R1Y3RzLmludmVudG9yeS5lMmUtc3BlYy50c1xuaW1wb3J0IHsgQXBwTW9kdWxlIH0gZnJvbSAnQC9hcHAubW9kdWxlJztcbmltcG9ydCB7IElOZXN0QXBwbGljYXRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBUZXN0IH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCByZXF1ZXN0IGZyb20gJ3N1cGVydGVzdCc7XG5cbmRlc2NyaWJlKCdQcm9kdWN0cyBpbnZlbnRvcnkgKGUyZSknLCAoKSA9PiB7XG4gIGxldCBhcHA6IElOZXN0QXBwbGljYXRpb247XG4gIGNvbnN0IE9SRyA9IHByb2Nlc3MuZW52Lk9SRyB8fCAnZGVtbyc7XG4gIGNvbnN0IEVNQUlMID0gcHJvY2Vzcy5lbnYuQVBJX0VNQUlMIHx8ICd0ZXN0ZXJAZXhhbXBsZS5jb20nO1xuICBjb25zdCBQQVNTID0gcHJvY2Vzcy5lbnYuQVBJX1BBU1MgfHwgJ3Bhc3N3b3JkMTIzJztcblxuICBiZWZvcmVBbGwoYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IG1vZHVsZVJlZiA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG4gICAgICBpbXBvcnRzOiBbQXBwTW9kdWxlXSxcbiAgICB9KS5jb21waWxlKCk7XG5cbiAgICBhcHAgPSBtb2R1bGVSZWYuY3JlYXRlTmVzdEFwcGxpY2F0aW9uKCk7XG4gICAgYXdhaXQgYXBwLmluaXQoKTtcbiAgfSk7XG5cbiAgYWZ0ZXJBbGwoYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IGFwcC5jbG9zZSgpO1xuICB9KTtcblxuICBpdCgnbGlzdHMgcHJvZHVjdHMgYW5kIGFkanVzdHMgaW52ZW50b3J5ICs1LCB0aGVuIHJlamVjdHMgbmVnYXRpdmUgb3ZlcnNob290JywgYXN5bmMgKCkgPT4ge1xuICAgIC8vIGxvZ2luIChBUEkgcmV0dXJucyAyMDAgT0sgZm9yIGxvZ2luKVxuICAgIGNvbnN0IGxvZ2luID0gYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgLnBvc3QoJy9hdXRoL2xvZ2luJylcbiAgICAgIC5zZXQoJ3gtb3JnJywgT1JHKVxuICAgICAgLnNlbmQoeyBlbWFpbDogRU1BSUwsIHBhc3N3b3JkOiBQQVNTIH0pXG4gICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICBjb25zdCB0b2tlbjogc3RyaW5nID0gbG9naW4uYm9keT8uYWNjZXNzX3Rva2VuO1xuICAgIGV4cGVjdCh0b2tlbikudG9CZVRydXRoeSgpO1xuXG4gICAgY29uc3QgYXV0aCA9IHsgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3Rva2VufWAsICd4LW9yZyc6IE9SRyB9O1xuXG4gICAgLy8gZ2V0IHByb2R1Y3RzXG4gICAgY29uc3QgbGlzdCA9IGF3YWl0IHJlcXVlc3QoYXBwLmdldEh0dHBTZXJ2ZXIoKSlcbiAgICAgIC5nZXQoJy9wcm9kdWN0cycpXG4gICAgICAuc2V0KGF1dGgpXG4gICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICBjb25zdCBwcm9kdWN0ID0gbGlzdC5ib2R5Py5kYXRhPy5bMF07XG4gICAgZXhwZWN0KHByb2R1Y3Q/LmlkKS50b0JlVHJ1dGh5KCk7XG5cbiAgICAvLyBhZGp1c3QgKzUgKEFQSSByZXR1cm5zIDIwMSBDcmVhdGVkKVxuICAgIGNvbnN0IHVwID0gYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgLnBvc3QoYC9wcm9kdWN0cy8ke3Byb2R1Y3QuaWR9L2ludmVudG9yeWApXG4gICAgICAuc2V0KGF1dGgpXG4gICAgICAuc2VuZCh7IGRlbHRhOiA1IH0pXG4gICAgICAuZXhwZWN0KDIwMSk7XG5cbiAgICBleHBlY3QodXAuYm9keT8uaW52ZW50b3J5UXR5KS50b0JlKHByb2R1Y3QuaW52ZW50b3J5UXR5ICsgNSk7XG5cbiAgICAvLyBuZWdhdGl2ZSBndWFyZDogdHJ5IHRvIGRyb3AgYmVsb3cgemVybyAtPiA0MDBcbiAgICBjb25zdCBjdXJyZW50UXR5OiBudW1iZXIgPSB1cC5ib2R5Py5pbnZlbnRvcnlRdHkgPz8gMDtcbiAgICBjb25zdCBvdmVyc2hvb3QgPSAtKGN1cnJlbnRRdHkgKyAxKTtcblxuICAgIGF3YWl0IHJlcXVlc3QoYXBwLmdldEh0dHBTZXJ2ZXIoKSlcbiAgICAgIC5wb3N0KGAvcHJvZHVjdHMvJHtwcm9kdWN0LmlkfS9pbnZlbnRvcnlgKVxuICAgICAgLnNldChhdXRoKVxuICAgICAgLnNlbmQoeyBkZWx0YTogb3ZlcnNob290IH0pXG4gICAgICAuZXhwZWN0KDQwMCk7XG4gIH0pO1xufSk7Il0sInZlcnNpb24iOjN9