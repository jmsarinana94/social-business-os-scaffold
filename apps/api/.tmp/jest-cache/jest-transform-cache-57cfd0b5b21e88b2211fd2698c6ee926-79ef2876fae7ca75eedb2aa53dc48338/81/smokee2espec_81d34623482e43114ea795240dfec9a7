4c342fc013f32fc1c7b9ada00194945c
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const supertest_1 = __importDefault(require("supertest"));
const app_module_1 = require("../../src/app.module");
const auth_module_1 = require("../../src/modules/auth/auth.module");
describe('API smoke (e2e)', () => {
    let app;
    const ORG = 'demo';
    const baseHeaders = { 'x-org': ORG };
    beforeAll(async () => {
        const moduleRef = await testing_1.Test.createTestingModule({
            imports: [app_module_1.AppModule, auth_module_1.AuthModule], // ðŸ‘ˆ add this
        }).compile();
        app = moduleRef.createNestApplication();
        await app.init();
    });
    afterAll(async () => {
        await app.close();
    });
    it('auth + products CRUD', async () => {
        const server = app.getHttpServer();
        const email = `test_${Date.now()}@example.com`;
        const password = 'secret123';
        await (0, supertest_1.default)(server)
            .post('/auth/signup')
            .set(baseHeaders)
            .send({ email, password, name: 'Tester' })
            .expect(201);
        const login = await (0, supertest_1.default)(server)
            .post('/auth/login')
            .set(baseHeaders)
            .send({ email, password })
            .expect(200);
        const token = login.body?.access_token || login.body?.token || 'test-token';
        const headers = { ...baseHeaders, Authorization: `Bearer ${token}` };
        await (0, supertest_1.default)(server).get('/health').expect(200);
        const created = await (0, supertest_1.default)(server)
            .post('/products')
            .set(headers)
            .send({ title: 'Widget', type: 'physical', status: 'active', price: 12.34, description: 'Smoke' })
            .expect(201);
        const id = created.body.id ?? created.body.data?.id;
        await (0, supertest_1.default)(server).get('/products').set(headers).expect(200);
        await (0, supertest_1.default)(server).get(`/products/${id}`).set(headers).expect(200);
        await (0, supertest_1.default)(server).put(`/products/${id}`).set(headers).send({ price: 15.5 }).expect(200);
        await (0, supertest_1.default)(server).delete(`/products/${id}`).set(headers).expect(200);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hbm55c2FyaW5hbmEvRG93bmxvYWRzL3NvY2lhbC1idXNpbmVzcy1vcy1zY2FmZm9sZC12MC4yL2FwcHMvYXBpL3Rlc3QvZTJlL3Ntb2tlLmUyZS1zcGVjLnRzIiwibWFwcGluZ3MiOiI7Ozs7O0FBQ0EsNkNBQXVDO0FBQ3ZDLDBEQUFnQztBQUNoQyxxREFBaUQ7QUFDakQsb0VBQWdFO0FBRWhFLFFBQVEsQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLEVBQUU7SUFDL0IsSUFBSSxHQUFxQixDQUFDO0lBRTFCLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQztJQUNuQixNQUFNLFdBQVcsR0FBRyxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FBQztJQUVyQyxTQUFTLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDbkIsTUFBTSxTQUFTLEdBQUcsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDL0MsT0FBTyxFQUFFLENBQUMsc0JBQVMsRUFBRSx3QkFBVSxDQUFDLEVBQUUsY0FBYztTQUNqRCxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFYixHQUFHLEdBQUcsU0FBUyxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFDeEMsTUFBTSxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDbkIsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDbEIsTUFBTSxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDcEIsQ0FBQyxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsc0JBQXNCLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFDcEMsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBRW5DLE1BQU0sS0FBSyxHQUFHLFFBQVEsSUFBSSxDQUFDLEdBQUcsRUFBRSxjQUFjLENBQUM7UUFDL0MsTUFBTSxRQUFRLEdBQUcsV0FBVyxDQUFDO1FBRTdCLE1BQU0sSUFBQSxtQkFBTyxFQUFDLE1BQU0sQ0FBQzthQUNsQixJQUFJLENBQUMsY0FBYyxDQUFDO2FBQ3BCLEdBQUcsQ0FBQyxXQUFXLENBQUM7YUFDaEIsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLENBQUM7YUFDekMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWYsTUFBTSxLQUFLLEdBQUcsTUFBTSxJQUFBLG1CQUFPLEVBQUMsTUFBTSxDQUFDO2FBQ2hDLElBQUksQ0FBQyxhQUFhLENBQUM7YUFDbkIsR0FBRyxDQUFDLFdBQVcsQ0FBQzthQUNoQixJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLENBQUM7YUFDekIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWYsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLElBQUksRUFBRSxZQUFZLElBQUksS0FBSyxDQUFDLElBQUksRUFBRSxLQUFLLElBQUksWUFBWSxDQUFDO1FBRTVFLE1BQU0sT0FBTyxHQUFHLEVBQUUsR0FBRyxXQUFXLEVBQUUsYUFBYSxFQUFFLFVBQVUsS0FBSyxFQUFFLEVBQUUsQ0FBQztRQUVyRSxNQUFNLElBQUEsbUJBQU8sRUFBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWpELE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBQSxtQkFBTyxFQUFDLE1BQU0sQ0FBQzthQUNsQyxJQUFJLENBQUMsV0FBVyxDQUFDO2FBQ2pCLEdBQUcsQ0FBQyxPQUFPLENBQUM7YUFDWixJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxPQUFPLEVBQUUsQ0FBQzthQUNqRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFZixNQUFNLEVBQUUsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUM7UUFFcEQsTUFBTSxJQUFBLG1CQUFPLEVBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFaEUsTUFBTSxJQUFBLG1CQUFPLEVBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRXRFLE1BQU0sSUFBQSxtQkFBTyxFQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUU1RixNQUFNLElBQUEsbUJBQU8sRUFBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsYUFBYSxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDM0UsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWFubnlzYXJpbmFuYS9Eb3dubG9hZHMvc29jaWFsLWJ1c2luZXNzLW9zLXNjYWZmb2xkLXYwLjIvYXBwcy9hcGkvdGVzdC9lMmUvc21va2UuZTJlLXNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSU5lc3RBcHBsaWNhdGlvbiB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFRlc3QgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnO1xuaW1wb3J0IHJlcXVlc3QgZnJvbSAnc3VwZXJ0ZXN0JztcbmltcG9ydCB7IEFwcE1vZHVsZSB9IGZyb20gJy4uLy4uL3NyYy9hcHAubW9kdWxlJztcbmltcG9ydCB7IEF1dGhNb2R1bGUgfSBmcm9tICcuLi8uLi9zcmMvbW9kdWxlcy9hdXRoL2F1dGgubW9kdWxlJztcblxuZGVzY3JpYmUoJ0FQSSBzbW9rZSAoZTJlKScsICgpID0+IHtcbiAgbGV0IGFwcDogSU5lc3RBcHBsaWNhdGlvbjtcblxuICBjb25zdCBPUkcgPSAnZGVtbyc7XG4gIGNvbnN0IGJhc2VIZWFkZXJzID0geyAneC1vcmcnOiBPUkcgfTtcblxuICBiZWZvcmVBbGwoYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IG1vZHVsZVJlZiA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG4gICAgICBpbXBvcnRzOiBbQXBwTW9kdWxlLCBBdXRoTW9kdWxlXSwgLy8g8J+RiCBhZGQgdGhpc1xuICAgIH0pLmNvbXBpbGUoKTtcblxuICAgIGFwcCA9IG1vZHVsZVJlZi5jcmVhdGVOZXN0QXBwbGljYXRpb24oKTtcbiAgICBhd2FpdCBhcHAuaW5pdCgpO1xuICB9KTtcblxuICBhZnRlckFsbChhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgYXBwLmNsb3NlKCk7XG4gIH0pO1xuXG4gIGl0KCdhdXRoICsgcHJvZHVjdHMgQ1JVRCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBzZXJ2ZXIgPSBhcHAuZ2V0SHR0cFNlcnZlcigpO1xuXG4gICAgY29uc3QgZW1haWwgPSBgdGVzdF8ke0RhdGUubm93KCl9QGV4YW1wbGUuY29tYDtcbiAgICBjb25zdCBwYXNzd29yZCA9ICdzZWNyZXQxMjMnO1xuXG4gICAgYXdhaXQgcmVxdWVzdChzZXJ2ZXIpXG4gICAgICAucG9zdCgnL2F1dGgvc2lnbnVwJylcbiAgICAgIC5zZXQoYmFzZUhlYWRlcnMpXG4gICAgICAuc2VuZCh7IGVtYWlsLCBwYXNzd29yZCwgbmFtZTogJ1Rlc3RlcicgfSlcbiAgICAgIC5leHBlY3QoMjAxKTtcblxuICAgIGNvbnN0IGxvZ2luID0gYXdhaXQgcmVxdWVzdChzZXJ2ZXIpXG4gICAgICAucG9zdCgnL2F1dGgvbG9naW4nKVxuICAgICAgLnNldChiYXNlSGVhZGVycylcbiAgICAgIC5zZW5kKHsgZW1haWwsIHBhc3N3b3JkIH0pXG4gICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICBjb25zdCB0b2tlbiA9IGxvZ2luLmJvZHk/LmFjY2Vzc190b2tlbiB8fCBsb2dpbi5ib2R5Py50b2tlbiB8fCAndGVzdC10b2tlbic7XG5cbiAgICBjb25zdCBoZWFkZXJzID0geyAuLi5iYXNlSGVhZGVycywgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3Rva2VufWAgfTtcblxuICAgIGF3YWl0IHJlcXVlc3Qoc2VydmVyKS5nZXQoJy9oZWFsdGgnKS5leHBlY3QoMjAwKTtcblxuICAgIGNvbnN0IGNyZWF0ZWQgPSBhd2FpdCByZXF1ZXN0KHNlcnZlcilcbiAgICAgIC5wb3N0KCcvcHJvZHVjdHMnKVxuICAgICAgLnNldChoZWFkZXJzKVxuICAgICAgLnNlbmQoeyB0aXRsZTogJ1dpZGdldCcsIHR5cGU6ICdwaHlzaWNhbCcsIHN0YXR1czogJ2FjdGl2ZScsIHByaWNlOiAxMi4zNCwgZGVzY3JpcHRpb246ICdTbW9rZScgfSlcbiAgICAgIC5leHBlY3QoMjAxKTtcblxuICAgIGNvbnN0IGlkID0gY3JlYXRlZC5ib2R5LmlkID8/IGNyZWF0ZWQuYm9keS5kYXRhPy5pZDtcblxuICAgIGF3YWl0IHJlcXVlc3Qoc2VydmVyKS5nZXQoJy9wcm9kdWN0cycpLnNldChoZWFkZXJzKS5leHBlY3QoMjAwKTtcblxuICAgIGF3YWl0IHJlcXVlc3Qoc2VydmVyKS5nZXQoYC9wcm9kdWN0cy8ke2lkfWApLnNldChoZWFkZXJzKS5leHBlY3QoMjAwKTtcblxuICAgIGF3YWl0IHJlcXVlc3Qoc2VydmVyKS5wdXQoYC9wcm9kdWN0cy8ke2lkfWApLnNldChoZWFkZXJzKS5zZW5kKHsgcHJpY2U6IDE1LjUgfSkuZXhwZWN0KDIwMCk7XG5cbiAgICBhd2FpdCByZXF1ZXN0KHNlcnZlcikuZGVsZXRlKGAvcHJvZHVjdHMvJHtpZH1gKS5zZXQoaGVhZGVycykuZXhwZWN0KDIwMCk7XG4gIH0pO1xufSk7Il0sInZlcnNpb24iOjN9