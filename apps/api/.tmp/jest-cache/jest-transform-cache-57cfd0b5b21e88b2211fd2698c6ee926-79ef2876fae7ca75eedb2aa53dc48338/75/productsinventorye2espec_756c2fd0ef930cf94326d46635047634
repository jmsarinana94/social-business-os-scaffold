3c9136b2bb51bd56f7b91cb4eb924c8a
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const common_1 = require("@nestjs/common");
const testing_1 = require("@nestjs/testing");
const supertest_1 = __importDefault(require("supertest"));
const app_module_1 = require("../../src/app.module");
const ORG = process.env.ORG || 'demo';
const EMAIL = process.env.API_EMAIL || 'tester@example.com';
const PASS = process.env.API_PASS || 'password123';
describe('Products inventory (e2e)', () => {
    let app;
    let token;
    beforeAll(async () => {
        const moduleRef = await testing_1.Test.createTestingModule({ imports: [app_module_1.AppModule] }).compile();
        app = moduleRef.createNestApplication();
        app.useGlobalPipes(new common_1.ValidationPipe({ whitelist: true, transform: true }));
        await app.init();
        const res = await (0, supertest_1.default)(app.getHttpServer())
            .post('/auth/login')
            .set('x-org', ORG)
            .send({ email: EMAIL, password: PASS })
            .expect(201);
        token = res.body.access_token;
    });
    afterAll(async () => {
        await app.close();
    });
    it('lists products and adjusts inventory +5, then rejects negative overshoot', async () => {
        const list = await (0, supertest_1.default)(app.getHttpServer())
            .get('/products?page=1&limit=10')
            .set('x-org', ORG)
            .set('Authorization', `Bearer ${token}`)
            .expect(200);
        expect(list.body.data.length).toBeGreaterThan(0);
        const product = list.body.data[0];
        // +5
        const up = await (0, supertest_1.default)(app.getHttpServer())
            .post(`/products/${product.id}/inventory`)
            .set('x-org', ORG)
            .set('Authorization', `Bearer ${token}`)
            .send({ delta: 5 })
            .expect(201);
        expect(up.body.inventoryQty).toBe(product.inventoryQty + 5);
        // huge negative should 400
        await (0, supertest_1.default)(app.getHttpServer())
            .post(`/products/${product.id}/inventory`)
            .set('x-org', ORG)
            .set('Authorization', `Bearer ${token}`)
            .send({ delta: -999999 })
            .expect(400);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hbm55c2FyaW5hbmEvRG93bmxvYWRzL3NvY2lhbC1idXNpbmVzcy1vcy1zY2FmZm9sZC12MC4yL2FwcHMvYXBpL3Rlc3QvZTJlL3Byb2R1Y3RzLmludmVudG9yeS5lMmUtc3BlYy50cyIsIm1hcHBpbmdzIjoiOzs7OztBQUFBLDJDQUFrRTtBQUNsRSw2Q0FBdUM7QUFDdkMsMERBQWdDO0FBQ2hDLHFEQUFpRDtBQUVqRCxNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxNQUFNLENBQUM7QUFDdEMsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLElBQUksb0JBQW9CLENBQUM7QUFDNUQsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLElBQUksYUFBYSxDQUFDO0FBRW5ELFFBQVEsQ0FBQywwQkFBMEIsRUFBRSxHQUFHLEVBQUU7SUFDeEMsSUFBSSxHQUFxQixDQUFDO0lBQzFCLElBQUksS0FBYSxDQUFDO0lBRWxCLFNBQVMsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNuQixNQUFNLFNBQVMsR0FBRyxNQUFNLGNBQUksQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDLHNCQUFTLENBQUMsRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDckYsR0FBRyxHQUFHLFNBQVMsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQ3hDLEdBQUcsQ0FBQyxjQUFjLENBQUMsSUFBSSx1QkFBYyxDQUFDLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQzdFLE1BQU0sR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRWpCLE1BQU0sR0FBRyxHQUFHLE1BQU0sSUFBQSxtQkFBTyxFQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsQ0FBQzthQUMzQyxJQUFJLENBQUMsYUFBYSxDQUFDO2FBQ25CLEdBQUcsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDO2FBQ2pCLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDO2FBQ3RDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNmLEtBQUssR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQztJQUNoQyxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNsQixNQUFNLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNwQixDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQywwRUFBMEUsRUFBRSxLQUFLLElBQUksRUFBRTtRQUN4RixNQUFNLElBQUksR0FBRyxNQUFNLElBQUEsbUJBQU8sRUFBQyxHQUFHLENBQUMsYUFBYSxFQUFFLENBQUM7YUFDNUMsR0FBRyxDQUFDLDJCQUEyQixDQUFDO2FBQ2hDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDO2FBQ2pCLEdBQUcsQ0FBQyxlQUFlLEVBQUUsVUFBVSxLQUFLLEVBQUUsQ0FBQzthQUN2QyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFZixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2pELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRWxDLEtBQUs7UUFDTCxNQUFNLEVBQUUsR0FBRyxNQUFNLElBQUEsbUJBQU8sRUFBQyxHQUFHLENBQUMsYUFBYSxFQUFFLENBQUM7YUFDMUMsSUFBSSxDQUFDLGFBQWEsT0FBTyxDQUFDLEVBQUUsWUFBWSxDQUFDO2FBQ3pDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDO2FBQ2pCLEdBQUcsQ0FBQyxlQUFlLEVBQUUsVUFBVSxLQUFLLEVBQUUsQ0FBQzthQUN2QyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUM7YUFDbEIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWYsTUFBTSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFFNUQsMkJBQTJCO1FBQzNCLE1BQU0sSUFBQSxtQkFBTyxFQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsQ0FBQzthQUMvQixJQUFJLENBQUMsYUFBYSxPQUFPLENBQUMsRUFBRSxZQUFZLENBQUM7YUFDekMsR0FBRyxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUM7YUFDakIsR0FBRyxDQUFDLGVBQWUsRUFBRSxVQUFVLEtBQUssRUFBRSxDQUFDO2FBQ3ZDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDO2FBQ3hCLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNqQixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9tYW5ueXNhcmluYW5hL0Rvd25sb2Fkcy9zb2NpYWwtYnVzaW5lc3Mtb3Mtc2NhZmZvbGQtdjAuMi9hcHBzL2FwaS90ZXN0L2UyZS9wcm9kdWN0cy5pbnZlbnRvcnkuZTJlLXNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSU5lc3RBcHBsaWNhdGlvbiwgVmFsaWRhdGlvblBpcGUgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBUZXN0IH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCByZXF1ZXN0IGZyb20gJ3N1cGVydGVzdCc7XG5pbXBvcnQgeyBBcHBNb2R1bGUgfSBmcm9tICcuLi8uLi9zcmMvYXBwLm1vZHVsZSc7XG5cbmNvbnN0IE9SRyA9IHByb2Nlc3MuZW52Lk9SRyB8fCAnZGVtbyc7XG5jb25zdCBFTUFJTCA9IHByb2Nlc3MuZW52LkFQSV9FTUFJTCB8fCAndGVzdGVyQGV4YW1wbGUuY29tJztcbmNvbnN0IFBBU1MgPSBwcm9jZXNzLmVudi5BUElfUEFTUyB8fCAncGFzc3dvcmQxMjMnO1xuXG5kZXNjcmliZSgnUHJvZHVjdHMgaW52ZW50b3J5IChlMmUpJywgKCkgPT4ge1xuICBsZXQgYXBwOiBJTmVzdEFwcGxpY2F0aW9uO1xuICBsZXQgdG9rZW46IHN0cmluZztcblxuICBiZWZvcmVBbGwoYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IG1vZHVsZVJlZiA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7IGltcG9ydHM6IFtBcHBNb2R1bGVdIH0pLmNvbXBpbGUoKTtcbiAgICBhcHAgPSBtb2R1bGVSZWYuY3JlYXRlTmVzdEFwcGxpY2F0aW9uKCk7XG4gICAgYXBwLnVzZUdsb2JhbFBpcGVzKG5ldyBWYWxpZGF0aW9uUGlwZSh7IHdoaXRlbGlzdDogdHJ1ZSwgdHJhbnNmb3JtOiB0cnVlIH0pKTtcbiAgICBhd2FpdCBhcHAuaW5pdCgpO1xuXG4gICAgY29uc3QgcmVzID0gYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgLnBvc3QoJy9hdXRoL2xvZ2luJylcbiAgICAgIC5zZXQoJ3gtb3JnJywgT1JHKVxuICAgICAgLnNlbmQoeyBlbWFpbDogRU1BSUwsIHBhc3N3b3JkOiBQQVNTIH0pXG4gICAgICAuZXhwZWN0KDIwMSk7XG4gICAgdG9rZW4gPSByZXMuYm9keS5hY2Nlc3NfdG9rZW47XG4gIH0pO1xuXG4gIGFmdGVyQWxsKGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCBhcHAuY2xvc2UoKTtcbiAgfSk7XG5cbiAgaXQoJ2xpc3RzIHByb2R1Y3RzIGFuZCBhZGp1c3RzIGludmVudG9yeSArNSwgdGhlbiByZWplY3RzIG5lZ2F0aXZlIG92ZXJzaG9vdCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBsaXN0ID0gYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgLmdldCgnL3Byb2R1Y3RzP3BhZ2U9MSZsaW1pdD0xMCcpXG4gICAgICAuc2V0KCd4LW9yZycsIE9SRylcbiAgICAgIC5zZXQoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7dG9rZW59YClcbiAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgIGV4cGVjdChsaXN0LmJvZHkuZGF0YS5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICBjb25zdCBwcm9kdWN0ID0gbGlzdC5ib2R5LmRhdGFbMF07XG5cbiAgICAvLyArNVxuICAgIGNvbnN0IHVwID0gYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgLnBvc3QoYC9wcm9kdWN0cy8ke3Byb2R1Y3QuaWR9L2ludmVudG9yeWApXG4gICAgICAuc2V0KCd4LW9yZycsIE9SRylcbiAgICAgIC5zZXQoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7dG9rZW59YClcbiAgICAgIC5zZW5kKHsgZGVsdGE6IDUgfSlcbiAgICAgIC5leHBlY3QoMjAxKTtcblxuICAgIGV4cGVjdCh1cC5ib2R5LmludmVudG9yeVF0eSkudG9CZShwcm9kdWN0LmludmVudG9yeVF0eSArIDUpO1xuXG4gICAgLy8gaHVnZSBuZWdhdGl2ZSBzaG91bGQgNDAwXG4gICAgYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgLnBvc3QoYC9wcm9kdWN0cy8ke3Byb2R1Y3QuaWR9L2ludmVudG9yeWApXG4gICAgICAuc2V0KCd4LW9yZycsIE9SRylcbiAgICAgIC5zZXQoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7dG9rZW59YClcbiAgICAgIC5zZW5kKHsgZGVsdGE6IC05OTk5OTkgfSlcbiAgICAgIC5leHBlY3QoNDAwKTtcbiAgfSk7XG59KTsiXSwidmVyc2lvbiI6M30=