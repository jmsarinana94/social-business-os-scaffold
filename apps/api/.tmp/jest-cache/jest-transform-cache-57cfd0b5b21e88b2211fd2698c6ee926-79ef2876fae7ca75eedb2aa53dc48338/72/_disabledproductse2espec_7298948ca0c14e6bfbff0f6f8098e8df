34ac61f8c9dd7c3d90f4d022142f82a8
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
// apps/api/test/products.e2e-spec.ts
require("reflect-metadata");
const common_1 = require("@nestjs/common");
const testing_1 = require("@nestjs/testing");
const client_1 = require("@prisma/client");
const supertest_1 = __importDefault(require("supertest"));
const app_module_1 = require("../src/app.module");
const prisma_exception_filter_1 = require("../src/common/filters/prisma-exception.filter");
const prisma = new client_1.PrismaClient();
const ORG_SLUG = process.env.TEST_ORG ?? 'demo';
describe('Products (e2e)', () => {
    let app;
    beforeAll(async () => {
        // reset DB
        await prisma.$executeRawUnsafe('TRUNCATE TABLE "Product" RESTART IDENTITY CASCADE;');
        await prisma.$executeRawUnsafe('TRUNCATE TABLE "Organization" RESTART IDENTITY CASCADE;');
        // seed org
        await prisma.organization.create({
            data: { slug: ORG_SLUG, name: ORG_SLUG.toUpperCase() },
        });
        const moduleRef = await testing_1.Test.createTestingModule({
            imports: [app_module_1.AppModule],
        }).compile();
        app = moduleRef.createNestApplication();
        app.useGlobalPipes(new common_1.ValidationPipe({ whitelist: true, transform: true }));
        app.useGlobalFilters(new prisma_exception_filter_1.PrismaExceptionFilter());
        await app.init();
    });
    afterAll(async () => {
        await app.close();
        await prisma.$disconnect();
    });
    it('health', async () => {
        const res = await (0, supertest_1.default)(app.getHttpServer()).get('/health').expect(200);
        expect(res.body?.ok).toBe(true);
    });
    it('create/list/get/update/delete product', async () => {
        const agent = (0, supertest_1.default)(app.getHttpServer());
        const headers = { 'x-org': ORG_SLUG, 'content-type': 'application/json' };
        // create
        const createRes = await agent
            .post('/products')
            .set(headers)
            .send({ title: 'Widget', type: 'physical', status: 'active', price: 12, description: 'Test' })
            .expect(201);
        const id = createRes.body.id ?? createRes.body.data?.id;
        expect(id).toBeTruthy();
        // get
        const getRes = await agent.get(`/products/${id}`).set({ 'x-org': ORG_SLUG }).expect(200);
        expect(getRes.body.title).toEqual('Widget');
        // update
        const updRes = await agent
            .put(`/products/${id}`)
            .set(headers)
            .send({ title: 'Widget (updated)', price: 19 })
            .expect(200);
        expect(updRes.body.title).toEqual('Widget (updated)');
        // list
        const listRes = await agent.get('/products?page=1&limit=5').set({ 'x-org': ORG_SLUG }).expect(200);
        expect(Array.isArray(listRes.body.data)).toBe(true);
        expect(listRes.body.meta?.page).toBe(1);
        // delete
        await agent.delete(`/products/${id}`).set({ 'x-org': ORG_SLUG }).expect(200);
        await agent.get(`/products/${id}`).set({ 'x-org': ORG_SLUG }).expect(404);
    });
    it('rejects missing x-org', async () => {
        await (0, supertest_1.default)(app.getHttpServer()).get('/products').expect(400);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hbm55c2FyaW5hbmEvRG93bmxvYWRzL3NvY2lhbC1idXNpbmVzcy1vcy1zY2FmZm9sZC12MC4yL2FwcHMvYXBpL3Rlc3QvX2Rpc2FibGVkLnByb2R1Y3RzLmUyZS1zcGVjLnRzIiwibWFwcGluZ3MiOiI7Ozs7O0FBQUEscUNBQXFDO0FBQ3JDLDRCQUEwQjtBQUUxQiwyQ0FBa0U7QUFDbEUsNkNBQXVDO0FBQ3ZDLDJDQUE4QztBQUM5QywwREFBZ0M7QUFFaEMsa0RBQThDO0FBQzlDLDJGQUFzRjtBQUV0RixNQUFNLE1BQU0sR0FBRyxJQUFJLHFCQUFZLEVBQUUsQ0FBQztBQUNsQyxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsSUFBSSxNQUFNLENBQUM7QUFFaEQsUUFBUSxDQUFDLGdCQUFnQixFQUFFLEdBQUcsRUFBRTtJQUM5QixJQUFJLEdBQXFCLENBQUM7SUFFMUIsU0FBUyxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ25CLFdBQVc7UUFDWCxNQUFNLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxvREFBb0QsQ0FBQyxDQUFDO1FBQ3JGLE1BQU0sTUFBTSxDQUFDLGlCQUFpQixDQUFDLHlEQUF5RCxDQUFDLENBQUM7UUFFMUYsV0FBVztRQUNYLE1BQU0sTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUM7WUFDL0IsSUFBSSxFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLFdBQVcsRUFBRSxFQUFFO1NBQ3ZELENBQUMsQ0FBQztRQUVILE1BQU0sU0FBUyxHQUFHLE1BQU0sY0FBSSxDQUFDLG1CQUFtQixDQUFDO1lBQy9DLE9BQU8sRUFBRSxDQUFDLHNCQUFTLENBQUM7U0FDckIsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBRWIsR0FBRyxHQUFHLFNBQVMsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQ3hDLEdBQUcsQ0FBQyxjQUFjLENBQUMsSUFBSSx1QkFBYyxDQUFDLEVBQUUsU0FBUyxFQUFFLElBQUks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Q0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNwRCxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXhDLFNBQVM7UUFDVCxNQUFNLEtBQUssQ0FBQyxNQUFNLENBQUMsYUFBYSxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM3RSxNQUFNLEtBQUssQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUM1RSxDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyx1QkFBdUIsRUFBRSxLQUFLLElBQUksRUFBRTtRQUNyQyxNQUFNLElBQUEsbUJBQU8sRUFBQyxHQUFHLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2xFLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL21hbm55c2FyaW5hbmEvRG93bmxvYWRzL3NvY2lhbC1idXNpbmVzcy1vcy1zY2FmZm9sZC12MC4yL2FwcHMvYXBpL3Rlc3QvX2Rpc2FibGVkLnByb2R1Y3RzLmUyZS1zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIGFwcHMvYXBpL3Rlc3QvcHJvZHVjdHMuZTJlLXNwZWMudHNcbmltcG9ydCAncmVmbGVjdC1tZXRhZGF0YSc7XG5cbmltcG9ydCB7IElOZXN0QXBwbGljYXRpb24sIFZhbGlkYXRpb25QaXBlIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgVGVzdCB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5pbXBvcnQgeyBQcmlzbWFDbGllbnQgfSBmcm9tICdAcHJpc21hL2NsaWVudCc7XG5pbXBvcnQgcmVxdWVzdCBmcm9tICdzdXBlcnRlc3QnO1xuXG5pbXBvcnQgeyBBcHBNb2R1bGUgfSBmcm9tICcuLi9zcmMvYXBwLm1vZHVsZSc7XG5pbXBvcnQgeyBQcmlzbWFFeGNlcHRpb25GaWx0ZXIgfSBmcm9tICcuLi9zcmMvY29tbW9uL2ZpbHRlcnMvcHJpc21hLWV4Y2VwdGlvbi5maWx0ZXInO1xuXG5jb25zdCBwcmlzbWEgPSBuZXcgUHJpc21hQ2xpZW50KCk7XG5jb25zdCBPUkdfU0xVRyA9IHByb2Nlc3MuZW52LlRFU1RfT1JHID8/ICdkZW1vJztcblxuZGVzY3JpYmUoJ1Byb2R1Y3RzIChlMmUpJywgKCkgPT4ge1xuICBsZXQgYXBwOiBJTmVzdEFwcGxpY2F0aW9uO1xuXG4gIGJlZm9yZUFsbChhc3luYyAoKSA9PiB7XG4gICAgLy8gcmVzZXQgREJcbiAgICBhd2FpdCBwcmlzbWEuJGV4ZWN1dGVSYXdVbnNhZmUoJ1RSVU5DQVRFIFRBQkxFIFwiUHJvZHVjdFwiIFJFU1RBUlQgSURFTlRJVFkgQ0FTQ0FERTsnKTtcbiAgICBhd2FpdCBwcmlzbWEuJGV4ZWN1dGVSYXdVbnNhZmUoJ1RSVU5DQVRFIFRBQkxFIFwiT3JnYW5pemF0aW9uXCIgUkVTVEFSVCBJREVOVElUWSBDQVNDQURFOycpO1xuXG4gICAgLy8gc2VlZCBvcmdcbiAgICBhd2FpdCBwcmlzbWEub3JnYW5pemF0aW9uLmNyZWF0ZSh7XG4gICAgICBkYXRhOiB7IHNsdWc6IE9SR19TTFVHLCBuYW1lOiBPUkdfU0xVRy50b1VwcGVyQ2FzZSgpIH0sXG4gICAgfSk7XG5cbiAgICBjb25zdCBtb2R1bGVSZWYgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgaW1wb3J0czogW0FwcE1vZHVsZV0sXG4gICAgfSkuY29tcGlsZSgpO1xuXG4gICAgYXBwID0gbW9kdWxlUmVmLmNyZWF0ZU5lc3RBcHBsaWNhdGlvbigpO1xuICAgIGFwcC51c2VHbG9iYWxQaXBlcyhuZXcgVmFsaWRhdGlvblBpcGUoeyB3aGl0ZWxpc3Q6IHRydWUsIHRyYW5zZm9ybTogdHJ1ZSB9KSk7XG4gICAgYXBwLnVzZUdsb2JhbEZpbHRlcnMobmV3IFByaXNtYUV4Y2VwdGlvbkZpbHRlcigpKTtcbiAgICBhd2FpdCBhcHAuaW5pdCgpO1xuICB9KTtcblxuICBhZnRlckFsbChhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgYXBwLmNsb3NlKCk7XG4gICAgYXdhaXQgcHJpc21hLiRkaXNjb25uZWN0KCk7XG4gIH0pO1xuXG4gIGl0KCdoZWFsdGgnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcmVzID0gYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKS5nZXQoJy9oZWFsdGgnKS5leHBlY3QoMjAwKTtcbiAgICBleHBlY3QocmVzLmJvZHk/Lm9rKS50b0JlKHRydWUpO1xuICB9KTtcblxuICBpdCgnY3JlYXRlL2xpc3QvZ2V0L3VwZGF0ZS9kZWxldGUgcHJvZHVjdCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBhZ2VudCA9IHJlcXVlc3QoYXBwLmdldEh0dHBTZXJ2ZXIoKSk7XG4gICAgY29uc3QgaGVhZGVycyA9IHsgJ3gtb3JnJzogT1JHX1NMVUcsICdjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfTtcblxuICAgIC8vIGNyZWF0ZVxuICAgIGNvbnN0IGNyZWF0ZVJlcyA9IGF3YWl0IGFnZW50XG4gICAgICAucG9zdCgnL3Byb2R1Y3RzJylcbiAgICAgIC5zZXQoaGVhZGVycylcbiAgICAgIC5zZW5kKHsgdGl0bGU6ICdXaWRnZXQnLCB0eXBlOiAncGh5c2ljYWwnLCBzdGF0dXM6ICdhY3RpdmUnLCBwcmljZTogMTIsIGRlc2NyaXB0aW9uOiAnVGVzdCcgfSlcbiAgICAgIC5leHBlY3QoMjAxKTtcblxuICAgIGNvbnN0IGlkID0gY3JlYXRlUmVzLmJvZHkuaWQgPz8gY3JlYXRlUmVzLmJvZHkuZGF0YT8uaWQ7XG4gICAgZXhwZWN0KGlkKS50b0JlVHJ1dGh5KCk7XG5cbiAgICAvLyBnZXRcbiAgICBjb25zdCBnZXRSZXMgPSBhd2FpdCBhZ2VudC5nZXQoYC9wcm9kdWN0cy8ke2lkfWApLnNldCh7ICd4LW9yZyc6IE9SR19TTFVHIH0pLmV4cGVjdCgyMDApO1xuICAgIGV4cGVjdChnZXRSZXMuYm9keS50aXRsZSkudG9FcXVhbCgnV2lkZ2V0Jyk7XG5cbiAgICAvLyB1cGRhdGVcbiAgICBjb25zdCB1cGRSZXMgPSBhd2FpdCBhZ2VudFxuICAgICAgLnB1dChgL3Byb2R1Y3RzLyR7aWR9YClcbiAgICAgIC5zZXQoaGVhZGVycylcbiAgICAgIC5zZW5kKHsgdGl0bGU6ICdXaWRnZXQgKHVwZGF0ZWQpJywgcHJpY2U6IDE5IH0pXG4gICAgICAuZXhwZWN0KDIwMCk7XG4gICAgZXhwZWN0KHVwZFJlcy5ib2R5LnRpdGxlKS50b0VxdWFsKCdXaWRnZXQgKHVwZGF0ZWQpJyk7XG5cbiAgICAvLyBsaXN0XG4gICAgY29uc3QgbGlzdFJlcyA9IGF3YWl0IGFnZW50LmdldCgnL3Byb2R1Y3RzP3BhZ2U9MSZsaW1pdD01Jykuc2V0KHsgJ3gtb3JnJzogT1JHX1NMVUcgfSkuZXhwZWN0KDIwMCk7XG4gICAgZXhwZWN0KEFycmF5LmlzQXJyYXkobGlzdFJlcy5ib2R5LmRhdGEpKS50b0JlKHRydWUpO1xuICAgIGV4cGVjdChsaXN0UmVzLmJvZHkubWV0YT8ucGFnZSkudG9CZSgxKTtcblxuICAgIC8vIGRlbGV0ZVxuICAgIGF3YWl0IGFnZW50LmRlbGV0ZShgL3Byb2R1Y3RzLyR7aWR9YCkuc2V0KHsgJ3gtb3JnJzogT1JHX1NMVUcgfSkuZXhwZWN0KDIwMCk7XG4gICAgYXdhaXQgYWdlbnQuZ2V0KGAvcHJvZHVjdHMvJHtpZH1gKS5zZXQoeyAneC1vcmcnOiBPUkdfU0xVRyB9KS5leHBlY3QoNDA0KTtcbiAgfSk7XG5cbiAgaXQoJ3JlamVjdHMgbWlzc2luZyB4LW9yZycsIGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCByZXF1ZXN0KGFwcC5nZXRIdHRwU2VydmVyKCkpLmdldCgnL3Byb2R1Y3RzJykuZXhwZWN0KDQwMCk7XG4gIH0pO1xufSk7Il0sInZlcnNpb24iOjN9