2c9a30177a93475026f107df48fc45fe
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
// apps/api/test/e2e/products.duplicate-sku.e2e-spec.ts
const app_module_1 = require("@/app.module");
const testing_1 = require("@nestjs/testing");
const supertest_1 = __importDefault(require("supertest"));
describe('Products duplicate SKU (e2e)', () => {
    let app;
    const baseHeaders = { 'x-org': 'demo' };
    const email = 'dup-sku@demo.io';
    const password = 'pass123';
    beforeAll(async () => {
        const moduleRef = await testing_1.Test.createTestingModule({
            imports: [app_module_1.AppModule],
        }).compile();
        app = moduleRef.createNestApplication();
        await app.init();
        await (0, supertest_1.default)(app.getHttpServer())
            .post('/auth/signup')
            .set(baseHeaders)
            .send({ email, password, name: 'Dup Tester' });
        await (0, supertest_1.default)(app.getHttpServer())
            .post('/auth/login')
            .send({ email, password })
            .expect(200);
    });
    afterAll(async () => {
        await app.close();
    });
    it('201 then 409 for same SKU in same org', async () => {
        const login = await (0, supertest_1.default)(app.getHttpServer())
            .post('/auth/login')
            .send({ email, password })
            .expect(200);
        const token = login.body?.access_token;
        const headers = { ...baseHeaders, Authorization: `Bearer ${token}` };
        const payload = {
            sku: 'DUP-001',
            title: 'Widget',
            type: 'PHYSICAL',
            status: 'ACTIVE',
            price: '1.00',
        };
        await (0, supertest_1.default)(app.getHttpServer()).post('/products').set(headers).send(payload).expect(201);
        await (0, supertest_1.default)(app.getHttpServer()).post('/products').set(headers).send(payload).expect(409);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hbm55c2FyaW5hbmEvRG93bmxvYWRzL3NvY2lhbC1idXNpbmVzcy1vcy1zY2FmZm9sZC12MC4yL2FwcHMvYXBpL3Rlc3QvZTJlL3Byb2R1Y3RzLmR1cGxpY2F0ZS1za3UuZTJlLXNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSx1REFBdUQ7QUFDdkQsNkNBQXlDO0FBRXpDLDZDQUF1QztBQUN2QywwREFBZ0M7QUFFaEMsUUFBUSxDQUFDLDhCQUE4QixFQUFFLEdBQUcsRUFBRTtJQUM1QyxJQUFJLEdBQXFCLENBQUM7SUFDMUIsTUFBTSxXQUFXLEdBQUcsRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLENBQUM7SUFDeEMsTUFBTSxLQUFLLEdBQUcsaUJBQWlCLENBQUM7SUFDaEMsTUFBTSxRQUFRLEdBQUcsU0FBUyxDQUFDO0lBRTNCLFNBQVMsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNuQixNQUFNLFNBQVMsR0FBRyxNQUFNLGNBQUksQ0FBQyxtQkFBbUIsQ0FBQztZQUMvQyxPQUFPLEVBQUUsQ0FBQyxzQkFBUyxDQUFDO1NBQ3JCLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUViLEdBQUcsR0FBRyxTQUFTLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUN4QyxNQUFNLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUVqQixNQUFNLElBQUEsbUJBQU8sRUFBQyxHQUFHLENBQUMsYUFBYSxFQUFFLENBQUM7YUFDL0IsSUFBSSxDQUFDLGNBQWMsQ0FBQzthQUNwQixHQUFHLENBQUMsV0FBVyxDQUFDO2FBQ2hCLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUM7UUFFakQsTUFBTSxJQUFBLG1CQUFPLEVBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxDQUFDO2FBQy9CLElBQUksQ0FBQyxhQUFhLENBQUM7YUFDbkIsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxDQUFDO2FBQ3pCLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNqQixDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNsQixNQUFNLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNwQixDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyx1Q0FBdUMsRUFBRSxLQUFLLElBQUksRUFBRTtRQUNyRCxNQUFNLEtBQUssR0FBRyxNQUFNLElBQUEsbUJBQU8sRUFBQyxHQUFHLENBQUMsYUFBYSxFQUFFLENBQUM7YUFDN0MsSUFBSSxDQUFDLGFBQWEsQ0FBQzthQUNuQixJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLENBQUM7YUFDekIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWYsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLElBQUksRUFBRSxZQUFZLENBQUM7UUFDdkMsTUFBTSxPQUFPLEdBQUcsRUFBRSxHQUFHLFdBQVcsRUFBRSxhQUFhLEVBQUUsVUFBVSxLQUFLLEVBQUUsRUFBRSxDQUFDO1FBRXJFLE1BQU0sT0FBTyxHQUFHO1lBQ2QsR0FBRyxFQUFFLFNBQVM7WUFDZCxLQUFLLEVBQUUsUUFBUTtZQUNmLElBQUksRUFBRSxVQUFVO1lBQ2hCLE1BQU0sRUFBRSxRQUFRO1lBQ2hCLEtBQUssRUFBRSxNQUFNO1NBQ2QsQ0FBQztRQUVGLE1BQU0sSUFBQSxtQkFBTyxFQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM1RixNQUFNLElBQUEsbUJBQU8sRUFBQyxHQUFHLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDOUYsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWFubnlzYXJpbmFuYS9Eb3dubG9hZHMvc29jaWFsLWJ1c2luZXNzLW9zLXNjYWZmb2xkLXYwLjIvYXBwcy9hcGkvdGVzdC9lMmUvcHJvZHVjdHMuZHVwbGljYXRlLXNrdS5lMmUtc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBhcHBzL2FwaS90ZXN0L2UyZS9wcm9kdWN0cy5kdXBsaWNhdGUtc2t1LmUyZS1zcGVjLnRzXG5pbXBvcnQgeyBBcHBNb2R1bGUgfSBmcm9tICdAL2FwcC5tb2R1bGUnO1xuaW1wb3J0IHsgSU5lc3RBcHBsaWNhdGlvbiB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFRlc3QgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnO1xuaW1wb3J0IHJlcXVlc3QgZnJvbSAnc3VwZXJ0ZXN0JztcblxuZGVzY3JpYmUoJ1Byb2R1Y3RzIGR1cGxpY2F0ZSBTS1UgKGUyZSknLCAoKSA9PiB7XG4gIGxldCBhcHA6IElOZXN0QXBwbGljYXRpb247XG4gIGNvbnN0IGJhc2VIZWFkZXJzID0geyAneC1vcmcnOiAnZGVtbycgfTtcbiAgY29uc3QgZW1haWwgPSAnZHVwLXNrdUBkZW1vLmlvJztcbiAgY29uc3QgcGFzc3dvcmQgPSAncGFzczEyMyc7XG5cbiAgYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb2R1bGVSZWYgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgaW1wb3J0czogW0FwcE1vZHVsZV0sXG4gICAgfSkuY29tcGlsZSgpO1xuXG4gICAgYXBwID0gbW9kdWxlUmVmLmNyZWF0ZU5lc3RBcHBsaWNhdGlvbigpO1xuICAgIGF3YWl0IGFwcC5pbml0KCk7XG5cbiAgICBhd2FpdCByZXF1ZXN0KGFwcC5nZXRIdHRwU2VydmVyKCkpXG4gICAgICAucG9zdCgnL2F1dGgvc2lnbnVwJylcbiAgICAgIC5zZXQoYmFzZUhlYWRlcnMpXG4gICAgICAuc2VuZCh7IGVtYWlsLCBwYXNzd29yZCwgbmFtZTogJ0R1cCBUZXN0ZXInIH0pO1xuXG4gICAgYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgLnBvc3QoJy9hdXRoL2xvZ2luJylcbiAgICAgIC5zZW5kKHsgZW1haWwsIHBhc3N3b3JkIH0pXG4gICAgICAuZXhwZWN0KDIwMCk7XG4gIH0pO1xuXG4gIGFmdGVyQWxsKGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCBhcHAuY2xvc2UoKTtcbiAgfSk7XG5cbiAgaXQoJzIwMSB0aGVuIDQwOSBmb3Igc2FtZSBTS1UgaW4gc2FtZSBvcmcnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgbG9naW4gPSBhd2FpdCByZXF1ZXN0KGFwcC5nZXRIdHRwU2VydmVyKCkpXG4gICAgICAucG9zdCgnL2F1dGgvbG9naW4nKVxuICAgICAgLnNlbmQoeyBlbWFpbCwgcGFzc3dvcmQgfSlcbiAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgIGNvbnN0IHRva2VuID0gbG9naW4uYm9keT8uYWNjZXNzX3Rva2VuO1xuICAgIGNvbnN0IGhlYWRlcnMgPSB7IC4uLmJhc2VIZWFkZXJzLCBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dG9rZW59YCB9O1xuXG4gICAgY29uc3QgcGF5bG9hZCA9IHtcbiAgICAgIHNrdTogJ0RVUC0wMDEnLFxuICAgICAgdGl0bGU6ICdXaWRnZXQnLFxuICAgICAgdHlwZTogJ1BIWVNJQ0FMJyxcbiAgICAgIHN0YXR1czogJ0FDVElWRScsXG4gICAgICBwcmljZTogJzEuMDAnLFxuICAgIH07XG5cbiAgICBhd2FpdCByZXF1ZXN0KGFwcC5nZXRIdHRwU2VydmVyKCkpLnBvc3QoJy9wcm9kdWN0cycpLnNldChoZWFkZXJzKS5zZW5kKHBheWxvYWQpLmV4cGVjdCgyMDEpO1xuICAgIGF3YWl0IHJlcXVlc3QoYXBwLmdldEh0dHBTZXJ2ZXIoKSkucG9zdCgnL3Byb2R1Y3RzJykuc2V0KGhlYWRlcnMpLnNlbmQocGF5bG9hZCkuZXhwZWN0KDQwOSk7XG4gIH0pO1xufSk7Il0sInZlcnNpb24iOjN9