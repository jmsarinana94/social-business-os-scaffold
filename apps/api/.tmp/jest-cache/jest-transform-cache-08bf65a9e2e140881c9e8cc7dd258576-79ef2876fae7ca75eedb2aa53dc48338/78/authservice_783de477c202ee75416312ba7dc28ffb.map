{"file":"/Users/mannysarinana/Downloads/social-business-os-scaffold-v0.2/apps/api/src/modules/auth/auth.service.ts","mappings":"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","names":[],"sources":["/Users/mannysarinana/Downloads/social-business-os-scaffold-v0.2/apps/api/src/modules/auth/auth.service.ts"],"sourcesContent":["// apps/api/src/modules/auth/auth.service.ts\nimport { BadRequestException, Injectable, UnauthorizedException } from '@nestjs/common';\nimport { JwtService } from '@nestjs/jwt';\nimport * as bcrypt from 'bcrypt';\nimport { PrismaService } from '../../prisma/prisma.service';\n\ntype Creds = { org: string; email: string; password: string };\ntype Signup = Creds & { name?: string };\n\n@Injectable()\nexport class AuthService {\n  constructor(private readonly prisma: PrismaService, private readonly jwt: JwtService) {}\n\n  private async ensureOrg(slug: string) {\n    return this.prisma.organization.upsert({\n      where: { slug },\n      update: {},\n      create: { slug, name: slug },\n    });\n  }\n\n  // POST /auth/signup -> 201\n  async signup({ org, email, password, name }: Signup) {\n    if (!email || !password) throw new BadRequestException('email and password are required');\n\n    const orgRow = await this.ensureOrg(org);\n\n    const hash = await bcrypt.hash(password, Number(process.env.BCRYPT_SALT_ROUNDS ?? 10));\n    const user =\n      (await this.prisma.user.findUnique({ where: { email } })) ??\n      (await this.prisma.user.create({ data: { email, password: hash } }));\n\n    // Ensure membership (default MEMBER)\n    await this.prisma.orgMember.upsert({\n      where: { OrgMember_userId_orgId_key: { userId: user.id, orgId: orgRow.id } },\n      update: {},\n      create: { userId: user.id, orgId: orgRow.id, role: 'MEMBER' as any },\n    });\n\n    return { id: user.id, email: user.email };\n  }\n\n  // POST /auth/login -> 200 (always)\n  async login({ org, email, password }: Creds) {\n    const orgRow = await this.ensureOrg(org);\n\n    const user = await this.prisma.user.findUnique({ where: { email } });\n    if (!user) throw new UnauthorizedException('Invalid credentials');\n\n    const ok = await bcrypt.compare(password, user.password);\n    if (!ok) throw new UnauthorizedException('Invalid credentials');\n\n    // Ensure membership exists (in case the user was created in a different org earlier)\n    await this.prisma.orgMember.upsert({\n      where: { OrgMember_userId_orgId_key: { userId: user.id, orgId: orgRow.id } },\n      update: {},\n      create: { userId: user.id, orgId: orgRow.id, role: 'MEMBER' as any },\n    });\n\n    await this.prisma.user.update({\n      where: { id: user.id },\n      data: { lastLoginAt: new Date() },\n    });\n\n    const token = await this.jwt.signAsync({ sub: user.id, email: user.email });\n    return { access_token: token };\n  }\n\n  // GET /auth/me -> 200\n  async me(userId: string) {\n    if (!userId) throw new BadRequestException('Missing user id');\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n      select: { id: true, email: true },\n    });\n    if (!user) throw new UnauthorizedException('User not found');\n    return user;\n  }\n}"],"version":3}