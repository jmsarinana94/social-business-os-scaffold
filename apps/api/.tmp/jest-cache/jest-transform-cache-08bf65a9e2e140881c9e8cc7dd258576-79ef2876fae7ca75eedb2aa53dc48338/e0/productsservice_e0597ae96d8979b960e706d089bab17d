d6320df49c71abe4dcb91f072be40029
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ProductsService = void 0;
const common_1 = require("@nestjs/common");
const prisma_service_1 = require("../../shared/prisma/prisma.service");
function genSku(prefix = 'SKU') {
    const rand = Math.random().toString(36).slice(2, 7).toUpperCase();
    const ts = Date.now().toString(36).toUpperCase();
    return `${prefix}-${ts}${rand}`;
}
let ProductsService = class ProductsService {
    constructor(prisma) {
        this.prisma = prisma;
    }
    async ensureOrg(orgSlug) {
        return ((await this.prisma.organization.findUnique({ where: { slug: orgSlug } })) ??
            (await this.prisma.organization.create({
                data: { slug: orgSlug, name: orgSlug },
            })));
    }
    async list(orgSlug, page = 1, limit = 10) {
        const org = await this.ensureOrg(orgSlug);
        const [data, total] = await this.prisma.$transaction([
            this.prisma.product.findMany({
                where: { orgId: org.id },
                orderBy: { createdAt: 'desc' },
                skip: (page - 1) * limit,
                take: limit,
            }),
            this.prisma.product.count({ where: { orgId: org.id } }),
        ]);
        const pages = Math.max(1, Math.ceil(total / limit));
        return { data, meta: { page, limit, total, pages } };
    }
    async get(orgSlug, id) {
        const org = await this.ensureOrg(orgSlug);
        const row = await this.prisma.product.findFirst({
            where: { id, orgId: org.id },
        });
        if (!row)
            throw new common_1.NotFoundException('Product not found');
        return row;
    }
    async create(orgSlug, dto) {
        const org = await this.ensureOrg(orgSlug);
        const type = (typeof dto.type === 'string'
            ? dto.type.toUpperCase()
            : dto.type) ?? 'PHYSICAL';
        const status = (typeof dto.status === 'string'
            ? dto.status.toUpperCase()
            : dto.status) ?? 'ACTIVE';
        // Ensure a SKU (model requires non-null string)
        const sku = dto.sku && dto.sku.trim().length > 0 ? dto.sku : genSku('AUTO');
        const data = {
            sku,
            title: dto.title,
            description: dto.description ?? null,
            type: type,
            status: status,
            price: dto.price,
            org: { connect: { id: org.id } },
        };
        return this.prisma.product.create({ data });
    }
    async update(orgSlug, id, dto) {
        const org = await this.ensureOrg(orgSlug);
        const existing = await this.prisma.product.findFirst({
            where: { id, orgId: org.id },
        });
        if (!existing)
            throw new common_1.NotFoundException('Product not found');
        const partial = {
            ...(dto.sku !== undefined ? { sku: dto.sku } : {}),
            ...(dto.title !== undefined ? { title: dto.title } : {}),
            ...(dto.description !== undefined ? { description: dto.description } : {}),
            ...(dto.type !== undefined
                ? {
                    type: (typeof dto.type === 'string'
                        ? dto.type.toUpperCase()
                        : dto.type),
                }
                : {}),
            ...(dto.status !== undefined
                ? {
                    status: (typeof dto.status === 'string'
                        ? dto.status.toUpperCase()
                        : dto.status),
                }
                : {}),
            ...(dto.price !== undefined ? { price: dto.price } : {}),
        };
        return this.prisma.product.update({
            where: { id },
            data: partial,
        });
    }
    async remove(orgSlug, id) {
        const org = await this.ensureOrg(orgSlug);
        const existing = await this.prisma.product.findFirst({
            where: { id, orgId: org.id },
        });
        if (!existing)
            throw new common_1.NotFoundException('Product not found');
        await this.prisma.product.delete({ where: { id } });
        return { ok: true };
    }
    async readInventory(orgSlug, id) {
        const row = await this.get(orgSlug, id);
        return { id: row.id, inventoryQty: row.inventoryQty ?? 0 };
    }
    async adjustInventory(orgSlug, id, delta) {
        const org = await this.ensureOrg(orgSlug);
        const row = await this.prisma.product.findFirst({
            where: { id, orgId: org.id },
            select: { id: true, inventoryQty: true },
        });
        if (!row)
            throw new common_1.NotFoundException('Product not found');
        const next = (row.inventoryQty ?? 0) + Number(delta || 0);
        if (next < 0) {
            throw new Error('Inventory cannot go negative');
        }
        return this.prisma.product.update({
            where: { id },
            data: { inventoryQty: next },
        });
    }
};
exports.ProductsService = ProductsService;
exports.ProductsService = ProductsService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [prisma_service_1.PrismaService])
], ProductsService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hbm55c2FyaW5hbmEvRG93bmxvYWRzL3NvY2lhbC1idXNpbmVzcy1vcy1zY2FmZm9sZC12MC4yL2FwcHMvYXBpL3NyYy9tb2R1bGVzL3Byb2R1Y3RzL3Byb2R1Y3RzLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQStEO0FBRS9ELHVFQUFtRTtBQW1CbkUsU0FBUyxNQUFNLENBQUMsTUFBTSxHQUFHLEtBQUs7SUFDNUIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ2xFLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDakQsT0FBTyxHQUFHLE1BQU0sSUFBSSxFQUFFLEdBQUcsSUFBSSxFQUFFLENBQUM7QUFDbEMsQ0FBQztBQUdNLElBQU0sZUFBZSxHQUFyQixNQUFNLGVBQWU7SUFDMUIsWUFBNkIsTUFBcUI7UUFBckIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtJQUFHLENBQUM7SUFFOUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxPQUFlO1FBQ3JDLE9BQU8sQ0FDTCxDQUFDLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQztZQUN6RSxDQUFDLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDO2dCQUNyQyxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUU7YUFDdkMsQ0FBQyxDQUFDLENBQ0osQ0FBQztJQUNKLENBQUM7SUFFRCxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQWUs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Q0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDMUQsSUFBSSxJQUFJLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDYixNQUFNLElBQUksS0FBSyxDQUFDLDhCQUE4QixDQUFDLENBQUM7UUFDbEQsQ0FBQztRQUVELE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDO1lBQ2hDLEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRTtZQUNiLElBQUksRUFBRSxFQUFFLFlBQVksRUFBRSxJQUFJLEVBQUU7U0FDN0IsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGLENBQUE7QUF6SVksMENBQWU7MEJBQWYsZUFBZTtJQUQzQixJQUFBLG1CQUFVLEdBQUU7cUNBRTBCLDhCQUFhO0dBRHZDLGVBQWUsQ0F5STNCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9tYW5ueXNhcmluYW5hL0Rvd25sb2Fkcy9zb2NpYWwtYnVzaW5lc3Mtb3Mtc2NhZmZvbGQtdjAuMi9hcHBzL2FwaS9zcmMvbW9kdWxlcy9wcm9kdWN0cy9wcm9kdWN0cy5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE5vdEZvdW5kRXhjZXB0aW9uIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUHJpc21hLCBQcm9kdWN0U3RhdHVzLCBQcm9kdWN0VHlwZSB9IGZyb20gJ0BwcmlzbWEvY2xpZW50JztcbmltcG9ydCB7IFByaXNtYVNlcnZpY2UgfSBmcm9tICcuLi8uLi9zaGFyZWQvcHJpc21hL3ByaXNtYS5zZXJ2aWNlJztcblxuZXhwb3J0IGludGVyZmFjZSBDcmVhdGVQcm9kdWN0RHRvIHtcbiAgc2t1Pzogc3RyaW5nO1xuICB0aXRsZTogc3RyaW5nO1xuICBkZXNjcmlwdGlvbj86IHN0cmluZyB8IG51bGw7XG4gIHR5cGU6IFByb2R1Y3RUeXBlIHwgc3RyaW5nO1xuICBzdGF0dXM6IFByb2R1Y3RTdGF0dXMgfCBzdHJpbmc7XG4gIHByaWNlOiBzdHJpbmc7XG59XG5leHBvcnQgaW50ZXJmYWNlIFVwZGF0ZVByb2R1Y3REdG8ge1xuICBza3U/OiBzdHJpbmc7XG4gIHRpdGxlPzogc3RyaW5nO1xuICBkZXNjcmlwdGlvbj86IHN0cmluZyB8IG51bGw7XG4gIHR5cGU/OiBQcm9kdWN0VHlwZSB8IHN0cmluZztcbiAgc3RhdHVzPzogUHJvZHVjdFN0YXR1cyB8IHN0cmluZztcbiAgcHJpY2U/OiBzdHJpbmc7XG59XG5cbmZ1bmN0aW9uIGdlblNrdShwcmVmaXggPSAnU0tVJyk6IHN0cmluZyB7XG4gIGNvbnN0IHJhbmQgPSBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgyLCA3KS50b1VwcGVyQ2FzZSgpO1xuICBjb25zdCB0cyA9IERhdGUubm93KCkudG9TdHJpbmcoMzYpLnRvVXBwZXJDYXNlKCk7XG4gIHJldHVybiBgJHtwcmVmaXh9LSR7dHN9JHtyYW5kfWA7XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQcm9kdWN0c1NlcnZpY2Uge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHByaXNtYTogUHJpc21hU2VydmljZSkge31cblxuICBwcml2YXRlIGFzeW5jIGVuc3VyZU9yZyhvcmdTbHVnOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gKFxuICAgICAgKGF3YWl0IHRoaXMucHJpc21hLm9yZ2FuaXphdGlvbi5maW5kVW5pcXVlKHsgd2hlcmU6IHsgc2x1Zzogb3JnU2x1ZyB9IH0pKSA/P1xuICAgICAgKGF3YWl0IHRoaXMucHJpc21hLm9yZ2FuaXphdGlvbi5jcmVhdGUoe1xuICAgICAgICBkYXRhOiB7IHNsdWc6IG9yZ1NsdWcsIG5hbWU6IG9yZ1NsdWcgfSxcbiAgICAgIH0pKVxuICAgICk7XG4gIH1cblxuICBhc3luYyBsaXN0KG9yZ1NsdWc6IHN0cmluZywgcGFnZSA9IDEsIGxpbWl0ID0gMTApIHtcbiAgICBjb25zdCBvcmcgPSBhd2FpdCB0aGlzLmVuc3VyZU9yZyhvcmdTbHVnKTtcbiAgICBjb25zdCBbZGF0YSwgdG90YWxdID0gYXdhaXQgdGhpcy5wcmlzbWEuJHRyYW5zYWN0aW9uKFtcbiAgICAgIHRoaXMucHJpc21hLnByb2R1Y3QuZmluZE1hbnkoe1xuICAgICAgICB3aGVyZTogeyBvcmdJZDogb3JnLmlkIH0sXG4gICAgICAgIG9yZGVyQnk6IHsgY3JlYXRlZEF0OiAnZGVzYycgfSxcbiAgICAgICAgc2tpcDogKHBhZ2UgLSAxKSAqIGxpbWl0LFxuICAgICAgICB0YWtlOiBsaW1pdCxcbiAgICAgIH0pLFxuICAgICAgdGhpcy5wcmlzbWEucHJvZHVjdC5jb3VudCh7IHdoZXJlOiB7IG9yZ0lkOiBvcmcuaWQgfSB9KSxcbiAgICBdKTtcblxuICAgIGNvbnN0IHBhZ2VzID0gTWF0aC5tYXgoMSwgTWF0aC5jZWlsKHRvdGFsIC8gbGltaXQpKTtcbiAgICByZXR1cm4geyBkYXRhLCBtZXRhOiB7IHBhZ2UsIGxpbWl0LCB0b3RhbCwgcGFnZXMgfSB9O1xuICB9XG5cbiAgYXN5bmMgZ2V0KG9yZ1NsdWc6IHN0cmluZywgaWQ6IHN0cmluZykge1xuICAgIGNvbnN0IG9yZyA9IGF3YWl0IHRoaXMuZW5zdXJlT3JnKG9yZ1NsdWcpO1xuICAgIGNvbnN0IHJvdyA9IGF3YWl0IHRoaXMucHJpc21hLnByb2R1Y3QuZmluZEZpcnN0KHtcbiAgICAgIHdoZXJlOiB7IGlkLCBvcmdJZDogb3JnLmlkIH0sXG4gICAgfSk7XG4gICAgaWYgKCFyb3cpIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignUHJvZHVjdCBub3QgZm91bmQnKTtcbiAgICByZXR1cm4gcm93O1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlKG9yZ1NsdWc6IHN0cmluZywgZHRvOiBDcmVhdGVQcm9kdWN0RHRvKSB7XG4gICAgY29uc3Qgb3JnID0gYXdhaXQgdGhpcy5lbnN1cmVPcmcob3JnU2x1Zyk7XG5cbiAgICBjb25zdCB0eXBlID1cbiAgICAgICh0eXBlb2YgZHRvLnR5cGUgPT09ICdzdHJpbmcnXG4gICAgICAgID8gKGR0by50eXBlLnRvVXBwZXJDYXNlKCkgYXMgUHJvZHVjdFR5cGUpXG4gICAgICAgIDogZHRvLnR5cGUpID8/ICdQSFlTSUNBTCc7XG5cbiAgICBjb25zdCBzdGF0dXMgPVxuICAgICAgKHR5cGVvZiBkdG8uc3RhdHVzID09PSAnc3RyaW5nJ1xuICAgICAgICA/IChkdG8uc3RhdHVzLnRvVXBwZXJDYXNlKCkgYXMgUHJvZHVjdFN0YXR1cylcbiAgICAgICAgOiBkdG8uc3RhdHVzKSA/PyAnQUNUSVZFJztcblxuICAgIC8vIEVuc3VyZSBhIFNLVSAobW9kZWwgcmVxdWlyZXMgbm9uLW51bGwgc3RyaW5nKVxuICAgIGNvbnN0IHNrdSA9IGR0by5za3UgJiYgZHRvLnNrdS50cmltKCkubGVuZ3RoID4gMCA/IGR0by5za3UgOiBnZW5Ta3UoJ0FVVE8nKTtcblxuICAgIGNvbnN0IGRhdGE6IFByaXNtYS5Qcm9kdWN0Q3JlYXRlSW5wdXQgPSB7XG4gICAgICBza3UsXG4gICAgICB0aXRsZTogZHRvLnRpdGxlLFxuICAgICAgZGVzY3JpcHRpb246IGR0by5kZXNjcmlwdGlvbiA/PyBudWxsLFxuICAgICAgdHlwZTogdHlwZSBhcyBhbnksXG4gICAgICBzdGF0dXM6IHN0YXR1cyBhcyBhbnksXG4gICAgICBwcmljZTogZHRvLnByaWNlLFxuICAgICAgb3JnOiB7IGNvbm5lY3Q6IHsgaWQ6IG9yZy5pZCB9IH0sXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLnByaXNtYS5wcm9kdWN0LmNyZWF0ZSh7IGRhdGEgfSk7XG4gIH1cblxuICBhc3luYyB1cGRhdGUob3JnU2x1Zzogc3RyaW5nLCBpZDogc3RyaW5nLCBkdG86IFVwZGF0ZVByb2R1Y3REdG8pIHtcbiAgICBjb25zdCBvcmcgPSBhd2FpdCB0aGlzLmVuc3VyZU9yZyhvcmdTbHVnKTtcblxuICAgIGNvbnN0IGV4aXN0aW5nID0gYXdhaXQgdGhpcy5wcmlzbWEucHJvZHVjdC5maW5kRmlyc3Qoe1xuICAgICAgd2hlcmU6IHsgaWQsIG9yZ0lkOiBvcmcuaWQgfSxcbiAgICB9KTtcbiAgICBpZiAoIWV4aXN0aW5nKSB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ1Byb2R1Y3Qgbm90IGZvdW5kJyk7XG5cbiAgICBjb25zdCBwYXJ0aWFsOiBQcmlzbWEuUHJvZHVjdFVwZGF0ZUlucHV0ID0ge1xuICAgICAgLi4uKGR0by5za3UgIT09IHVuZGVmaW5lZCA/IHsgc2t1OiBkdG8uc2t1IH0gOiB7fSksXG4gICAgICAuLi4oZHRvLnRpdGxlICE9PSB1bmRlZmluZWQgPyB7IHRpdGxlOiBkdG8udGl0bGUgfSA6IHt9KSxcbiAgICAgIC4uLihkdG8uZGVzY3JpcHRpb24gIT09IHVuZGVmaW5lZCA/IHsgZGVzY3JpcHRpb246IGR0by5kZXNjcmlwdGlvbiB9IDoge30pLFxuICAgICAgLi4uKGR0by50eXBlICE9PSB1bmRlZmluZWRcbiAgICAgICAgPyB7XG4gICAgICAgICAgICB0eXBlOlxuICAgICAgICAgICAgICAodHlwZW9mIGR0by50eXBlID09PSAnc3RyaW5nJ1xuICAgICAgICAgICAgICAgID8gKGR0by50eXBlLnRvVXBwZXJDYXNlKCkgYXMgUHJvZHVjdFR5cGUpXG4gICAgICAgICAgICAgICAgOiBkdG8udHlwZSkgYXMgYW55LFxuICAgICAgICAgIH1cbiAgICAgICAgOiB7fSksXG4gICAgICAuLi4oZHRvLnN0YXR1cyAhPT0gdW5kZWZpbmVkXG4gICAgICAgID8ge1xuICAgICAgICAgICAgc3RhdHVzOlxuICAgICAgICAgICAgICAodHlwZW9mIGR0by5zdGF0dXMgPT09ICdzdHJpbmcnXG4gICAgICAgICAgICAgICAgPyAoZHRvLnN0YXR1cy50b1VwcGVyQ2FzZSgpIGFzIFByb2R1Y3RTdGF0dXMpXG4gICAgICAgICAgICAgICAgOiBkdG8uc3RhdHVzKSBhcyBhbnksXG4gICAgICAgICAgfVxuICAgICAgICA6IHt9KSxcbiAgICAgIC4uLihkdG8ucHJpY2UgIT09IHVuZGVmaW5lZCA/IHsgcHJpY2U6IGR0by5wcmljZSB9IDoge30pLFxuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5wcmlzbWEucHJvZHVjdC51cGRhdGUoe1xuICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICAgIGRhdGE6IHBhcnRpYWwsXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyByZW1vdmUob3JnU2x1Zzogc3RyaW5nLCBpZDogc3RyaW5nKSB7XG4gICAgY29uc3Qgb3JnID0gYXdhaXQgdGhpcy5lbnN1cmVPcmcob3JnU2x1Zyk7XG4gICAgY29uc3QgZXhpc3RpbmcgPSBhd2FpdCB0aGlzLnByaXNtYS5wcm9kdWN0LmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZTogeyBpZCwgb3JnSWQ6IG9yZy5pZCB9LFxuICAgIH0pO1xuICAgIGlmICghZXhpc3RpbmcpIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignUHJvZHVjdCBub3QgZm91bmQnKTtcblxuICAgIGF3YWl0IHRoaXMucHJpc21hLnByb2R1Y3QuZGVsZXRlKHsgd2hlcmU6IHsgaWQgfSB9KTtcbiAgICByZXR1cm4geyBvazogdHJ1ZSB9O1xuICB9XG5cbiAgYXN5bmMgcmVhZEludmVudG9yeShvcmdTbHVnOiBzdHJpbmcsIGlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCByb3cgPSBhd2FpdCB0aGlzLmdldChvcmdTbHVnLCBpZCk7XG4gICAgcmV0dXJuIHsgaWQ6IHJvdy5pZCwgaW52ZW50b3J5UXR5OiByb3cuaW52ZW50b3J5UXR5ID8/IDAgfTtcbiAgfVxuXG4gIGFzeW5jIGFkanVzdEludmVudG9yeShvcmdTbHVnOiBzdHJpbmcsIGlkOiBzdHJpbmcsIGRlbHRhOiBudW1iZXIpIHtcbiAgICBjb25zdCBvcmcgPSBhd2FpdCB0aGlzLmVuc3VyZU9yZyhvcmdTbHVnKTtcbiAgICBjb25zdCByb3cgPSBhd2FpdCB0aGlzLnByaXNtYS5wcm9kdWN0LmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZTogeyBpZCwgb3JnSWQ6IG9yZy5pZCB9LFxuICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCBpbnZlbnRvcnlRdHk6IHRydWUgfSxcbiAgICB9KTtcbiAgICBpZiAoIXJvdykgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdQcm9kdWN0IG5vdCBmb3VuZCcpO1xuXG4gICAgY29uc3QgbmV4dCA9IChyb3cuaW52ZW50b3J5UXR5ID8/IDApICsgTnVtYmVyKGRlbHRhIHx8IDApO1xuICAgIGlmIChuZXh0IDwgMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZlbnRvcnkgY2Fubm90IGdvIG5lZ2F0aXZlJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMucHJpc21hLnByb2R1Y3QudXBkYXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICBkYXRhOiB7IGludmVudG9yeVF0eTogbmV4dCB9LFxuICAgIH0pO1xuICB9XG59Il0sInZlcnNpb24iOjN9