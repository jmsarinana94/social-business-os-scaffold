{"file":"/Users/mannysarinana/Downloads/social-business-os-scaffold-v0.2/apps/api/src/modules/products/products.service.ts","mappings":"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","names":[],"sources":["/Users/mannysarinana/Downloads/social-business-os-scaffold-v0.2/apps/api/src/modules/products/products.service.ts"],"sourcesContent":["import { Injectable, NotFoundException } from '@nestjs/common';\nimport { Prisma, ProductStatus, ProductType } from '@prisma/client';\nimport { PrismaService } from '../../shared/prisma/prisma.service';\n\nexport interface CreateProductDto {\n  sku?: string;\n  title: string;\n  description?: string | null;\n  type: ProductType | string;\n  status: ProductStatus | string;\n  price: string;\n}\nexport interface UpdateProductDto {\n  sku?: string;\n  title?: string;\n  description?: string | null;\n  type?: ProductType | string;\n  status?: ProductStatus | string;\n  price?: string;\n}\n\nfunction genSku(prefix = 'SKU'): string {\n  const rand = Math.random().toString(36).slice(2, 7).toUpperCase();\n  const ts = Date.now().toString(36).toUpperCase();\n  return `${prefix}-${ts}${rand}`;\n}\n\n@Injectable()\nexport class ProductsService {\n  constructor(private readonly prisma: PrismaService) {}\n\n  private async ensureOrg(orgSlug: string) {\n    return (\n      (await this.prisma.organization.findUnique({ where: { slug: orgSlug } })) ??\n      (await this.prisma.organization.create({\n        data: { slug: orgSlug, name: orgSlug },\n      }))\n    );\n  }\n\n  async list(orgSlug: string, page = 1, limit = 10) {\n    const org = await this.ensureOrg(orgSlug);\n    const [data, total] = await this.prisma.$transaction([\n      this.prisma.product.findMany({\n        where: { orgId: org.id },\n        orderBy: { createdAt: 'desc' },\n        skip: (page - 1) * limit,\n        take: limit,\n      }),\n      this.prisma.product.count({ where: { orgId: org.id } }),\n    ]);\n\n    const pages = Math.max(1, Math.ceil(total / limit));\n    return { data, meta: { page, limit, total, pages } };\n  }\n\n  async get(orgSlug: string, id: string) {\n    const org = await this.ensureOrg(orgSlug);\n    const row = await this.prisma.product.findFirst({\n      where: { id, orgId: org.id },\n    });\n    if (!row) throw new NotFoundException('Product not found');\n    return row;\n  }\n\n  async create(orgSlug: string, dto: CreateProductDto) {\n    const org = await this.ensureOrg(orgSlug);\n\n    const type =\n      (typeof dto.type === 'string'\n        ? (dto.type.toUpperCase() as ProductType)\n        : dto.type) ?? 'PHYSICAL';\n\n    const status =\n      (typeof dto.status === 'string'\n        ? (dto.status.toUpperCase() as ProductStatus)\n        : dto.status) ?? 'ACTIVE';\n\n    // Ensure a SKU (model requires non-null string)\n    const sku = dto.sku && dto.sku.trim().length > 0 ? dto.sku : genSku('AUTO');\n\n    const data: Prisma.ProductCreateInput = {\n      sku,\n      title: dto.title,\n      description: dto.description ?? null,\n      type: type as any,\n      status: status as any,\n      price: dto.price,\n      org: { connect: { id: org.id } },\n    };\n\n    return this.prisma.product.create({ data });\n  }\n\n  async update(orgSlug: string, id: string, dto: UpdateProductDto) {\n    const org = await this.ensureOrg(orgSlug);\n\n    const existing = await this.prisma.product.findFirst({\n      where: { id, orgId: org.id },\n    });\n    if (!existing) throw new NotFoundException('Product not found');\n\n    const partial: Prisma.ProductUpdateInput = {\n      ...(dto.sku !== undefined ? { sku: dto.sku } : {}),\n      ...(dto.title !== undefined ? { title: dto.title } : {}),\n      ...(dto.description !== undefined ? { description: dto.description } : {}),\n      ...(dto.type !== undefined\n        ? {\n            type:\n              (typeof dto.type === 'string'\n                ? (dto.type.toUpperCase() as ProductType)\n                : dto.type) as any,\n          }\n        : {}),\n      ...(dto.status !== undefined\n        ? {\n            status:\n              (typeof dto.status === 'string'\n                ? (dto.status.toUpperCase() as ProductStatus)\n                : dto.status) as any,\n          }\n        : {}),\n      ...(dto.price !== undefined ? { price: dto.price } : {}),\n    };\n\n    return this.prisma.product.update({\n      where: { id },\n      data: partial,\n    });\n  }\n\n  async remove(orgSlug: string, id: string) {\n    const org = await this.ensureOrg(orgSlug);\n    const existing = await this.prisma.product.findFirst({\n      where: { id, orgId: org.id },\n    });\n    if (!existing) throw new NotFoundException('Product not found');\n\n    await this.prisma.product.delete({ where: { id } });\n    return { ok: true };\n  }\n\n  async readInventory(orgSlug: string, id: string) {\n    const row = await this.get(orgSlug, id);\n    return { id: row.id, inventoryQty: row.inventoryQty ?? 0 };\n  }\n\n  async adjustInventory(orgSlug: string, id: string, delta: number) {\n    const org = await this.ensureOrg(orgSlug);\n    const row = await this.prisma.product.findFirst({\n      where: { id, orgId: org.id },\n      select: { id: true, inventoryQty: true },\n    });\n    if (!row) throw new NotFoundException('Product not found');\n\n    const next = (row.inventoryQty ?? 0) + Number(delta || 0);\n    if (next < 0) {\n      throw new Error('Inventory cannot go negative');\n    }\n\n    return this.prisma.product.update({\n      where: { id },\n      data: { inventoryQty: next },\n    });\n  }\n}"],"version":3}