{"file":"/Users/mannysarinana/Downloads/social-business-os-scaffold-v0.2/apps/api/src/modules/products/products.service.ts","mappings":"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","names":[],"sources":["/Users/mannysarinana/Downloads/social-business-os-scaffold-v0.2/apps/api/src/modules/products/products.service.ts"],"sourcesContent":["import {\n  BadRequestException,\n  ConflictException,\n  Injectable,\n  NotFoundException,\n} from '@nestjs/common';\nimport { Prisma, ProductStatus, ProductType } from '@prisma/client';\nimport { PrismaService } from '../../shared/prisma/prisma.service';\n\n// DTOs the controller expects to pass in.\n// (Matches the controllerâ€™s Create/Update shapes used in tests)\nexport type CreateDto = {\n  sku?: string;\n  title: string;\n  description?: string | null;\n  type: ProductType | 'PHYSICAL' | 'DIGITAL';\n  status: ProductStatus | 'ACTIVE' | 'INACTIVE';\n  price: string; // stored as DECIMAL -> string in Prisma client\n};\n\nexport type UpdateDto = Partial<CreateDto>;\n\n@Injectable()\nexport class ProductsService {\n  constructor(private readonly prisma: PrismaService) {}\n\n  private async ensureOrg(orgSlug: string) {\n    const org = await this.prisma.organization.findUnique({\n      where: { slug: orgSlug },\n      select: { id: true },\n    });\n    if (org) return org;\n    // Create on first use (tests assume org is there)\n    return this.prisma.organization.create({\n      data: { slug: orgSlug, name: orgSlug },\n      select: { id: true },\n    });\n  }\n\n  async list(orgSlug: string, page = 1, limit = 10) {\n    const org = await this.ensureOrg(orgSlug);\n    const [total, data] = await this.prisma.$transaction([\n      this.prisma.product.count({ where: { orgId: org.id } }),\n      this.prisma.product.findMany({\n        where: { orgId: org.id },\n        orderBy: { createdAt: 'desc' },\n        skip: (page - 1) * limit,\n        take: limit,\n      }),\n    ]);\n    return {\n      data,\n      meta: {\n        page,\n        limit,\n        total,\n        pages: Math.max(1, Math.ceil(total / limit)),\n      },\n    };\n  }\n\n  async get(orgSlug: string, id: string) {\n    const org = await this.ensureOrg(orgSlug);\n    const row = await this.prisma.product.findFirst({\n      where: { id, orgId: org.id },\n    });\n    if (!row) throw new NotFoundException('Product not found');\n    return row;\n  }\n\n  private genSku(): string {\n    // Simple, deterministic-enough auto SKU for tests/CLI\n    const rand = Math.random().toString(36).slice(2, 8).toUpperCase();\n    return `AUTO-${rand}`;\n  }\n\n  async create(orgSlug: string, dto: CreateDto) {\n    const org = await this.ensureOrg(orgSlug);\n\n    // Normalize/validate fields to match enums\n    const type =\n      typeof dto.type === 'string'\n        ? (dto.type.toUpperCase() as ProductType)\n        : dto.type;\n    const status =\n      typeof dto.status === 'string'\n        ? (dto.status.toUpperCase() as ProductStatus)\n        : dto.status;\n\n    const data: Prisma.ProductCreateInput = {\n      sku: dto.sku ?? this.genSku(),\n      title: dto.title,\n      description: dto.description ?? null,\n      type,\n      status,\n      price: dto.price, // Prisma decimal represented as string\n      org: { connect: { id: org.id } },\n    };\n\n    try {\n      return await this.prisma.product.create({ data });\n    } catch (err: any) {\n      // Surface duplicate SKU (orgId, sku) as HTTP 409 as tests expect\n      if (err?.code === 'P2002') {\n        return Promise.reject(\n          new ConflictException('SKU already exists in this org'),\n        );\n      }\n      throw err;\n    }\n  }\n\n  async update(orgSlug: string, id: string, dto: UpdateDto) {\n    const org = await this.ensureOrg(orgSlug);\n    const existing = await this.prisma.product.findFirst({\n      where: { id, orgId: org.id },\n      select: { id: true },\n    });\n    if (!existing) throw new NotFoundException('Product not found');\n\n    const data: Prisma.ProductUpdateInput = {\n      ...(dto.title !== undefined ? { title: dto.title } : {}),\n      ...(dto.description !== undefined ? { description: dto.description } : {}),\n      ...(dto.type !== undefined\n        ? {\n            type:\n              typeof dto.type === 'string'\n                ? (dto.type.toUpperCase() as ProductType)\n                : dto.type,\n          }\n        : {}),\n      ...(dto.status !== undefined\n        ? {\n            status:\n              typeof dto.status === 'string'\n                ? (dto.status.toUpperCase() as ProductStatus)\n                : dto.status,\n          }\n        : {}),\n      ...(dto.price !== undefined ? { price: dto.price } : {}),\n      ...(dto.sku !== undefined ? { sku: dto.sku } : {}),\n    };\n\n    try {\n      return await this.prisma.product.update({\n        where: { id },\n        data,\n      });\n    } catch (err: any) {\n      if (err?.code === 'P2002') {\n        // Changing SKU to a duplicate\n        return Promise.reject(\n          new ConflictException('SKU already exists in this org'),\n        );\n      }\n      throw err;\n    }\n  }\n\n  async remove(orgSlug: string, id: string) {\n    const org = await this.ensureOrg(orgSlug);\n    const existing = await this.prisma.product.findFirst({\n      where: { id, orgId: org.id },\n      select: { id: true },\n    });\n    if (!existing) throw new NotFoundException('Product not found');\n\n    await this.prisma.product.delete({ where: { id } });\n    return { ok: true };\n  }\n\n  // ---- Inventory ----\n\n  async getInventory(orgSlug: string, id: string) {\n    const org = await this.ensureOrg(orgSlug);\n    const row = await this.prisma.product.findFirst({\n      where: { id, orgId: org.id },\n      select: { id: true, inventoryQty: true },\n    });\n    if (!row) throw new NotFoundException('Product not found');\n    return row;\n  }\n\n  async adjustInventory(orgSlug: string, id: string, delta: number) {\n    if (!Number.isFinite(delta)) {\n      throw new BadRequestException('delta must be a number');\n    }\n\n    const org = await this.ensureOrg(orgSlug);\n    const prod = await this.prisma.product.findFirst({\n      where: { id, orgId: org.id },\n      select: { id: true, inventoryQty: true },\n    });\n    if (!prod) throw new NotFoundException('Product not found');\n\n    const next = (prod.inventoryQty ?? 0) + Number(delta);\n    if (next < 0) {\n      throw new BadRequestException('Inventory cannot go negative');\n    }\n\n    return this.prisma.product.update({\n      where: { id },\n      data: { inventoryQty: next },\n    });\n  }\n}"],"version":3}