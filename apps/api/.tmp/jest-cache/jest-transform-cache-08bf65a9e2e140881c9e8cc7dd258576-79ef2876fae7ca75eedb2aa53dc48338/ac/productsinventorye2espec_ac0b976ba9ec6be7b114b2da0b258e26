25da1cbc47e75968e12b762bbac1c684
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
// apps/api/test/e2e/products.inventory.e2e-spec.ts
const app_module_1 = require("@/app.module");
const testing_1 = require("@nestjs/testing");
const supertest_1 = __importDefault(require("supertest"));
const ORG = process.env.ORG || 'demo';
const EMAIL = process.env.API_EMAIL || 'tester@example.com';
const PASS = process.env.API_PASS || 'password123';
describe('Products inventory (e2e)', () => {
    let app;
    let token;
    const base = () => (0, supertest_1.default)(app.getHttpServer());
    const baseHeaders = { 'x-org': ORG, 'content-type': 'application/json' };
    beforeAll(async () => {
        const moduleRef = await testing_1.Test.createTestingModule({
            imports: [app_module_1.AppModule],
        }).compile();
        app = moduleRef.createNestApplication();
        await app.init();
        // Try to ensure the user exists (idempotent: 201 or 409 are okay)
        await base().post('/auth/signup').set(baseHeaders).send({
            email: EMAIL,
            password: PASS,
            name: 'Inventory Tester',
        }).ok(res => res.status === 201 || res.status === 409);
        // Now login (must be 200)
        const login = await base()
            .post('/auth/login')
            .set(baseHeaders)
            .send({ email: EMAIL, password: PASS })
            .expect(200);
        token = login.body?.access_token;
        expect(token).toBeTruthy();
    });
    afterAll(async () => {
        await app.close();
    });
    it('lists products and adjusts inventory +5, then rejects negative overshoot', async () => {
        // 1) List products
        const list = await base().get('/products')
            .set({ ...baseHeaders, Authorization: `Bearer ${token}` })
            .expect(200);
        expect(Array.isArray(list.body?.data)).toBe(true);
        expect(list.body.data.length).toBeGreaterThan(0);
        // pick first item that has inventoryQty field (all should)
        const product = list.body.data[0];
        expect(product).toHaveProperty('id');
        expect(product).toHaveProperty('inventoryQty');
        // 2) Adjust +5
        const up = await base()
            .post(`/products/${product.id}/inventory`)
            .set({ ...baseHeaders, Authorization: `Bearer ${token}` })
            .send({ delta: 5 })
            // Some implementations return 201 Created for a mutating action; accept 200 or 201
            .ok(res => res.status === 200 || res.status === 201);
        expect(up.body?.inventoryQty).toBe(product.inventoryQty + 5);
        // 3) Attempt negative overshoot (should 400)
        const neg = await base()
            .post(`/products/${product.id}/inventory`)
            .set({ ...baseHeaders, Authorization: `Bearer ${token}` })
            .send({ delta: -(product.inventoryQty + 6) })
            .expect(400);
        expect(neg.body?.message || '').toMatch(/(cannot|invalid|negative|overshoot)/i);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hbm55c2FyaW5hbmEvRG93bmxvYWRzL3NvY2lhbC1idXNpbmVzcy1vcy1zY2FmZm9sZC12MC4yL2FwcHMvYXBpL3Rlc3QvZTJlL3Byb2R1Y3RzLmludmVudG9yeS5lMmUtc3BlYy50cyIsIm1hcHBpbmdzIjoiOzs7OztBQUFBLG1EQUFtRDtBQUNuRCw2Q0FBeUM7QUFFekMsNkNBQXVDO0FBQ3ZDLDBEQUFnQztBQUVoQyxNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxNQUFNLENBQUM7QUFDdEMsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLElBQUksb0JBQW9CLENBQUM7QUFDNUQsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLElBQUksYUFBYSxDQUFDO0FBRW5ELFFBQVEsQ0FBQywwQkFBMEIsRUFBRSxHQUFHLEVBQUU7SUFDeEMsSUFBSSxHQUFxQixDQUFDO0lBQzFCLElBQUksS0FBYSxDQUFDO0lBRWxCLE1BQU0sSUFBSSxHQUFHLEdBQUcsRUFBRSxDQUFDLElBQUEsbUJBQU8sRUFBQyxHQUFHLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FBQztJQUNoRCxNQUFNLFdBQVcsR0FBRyxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLENBQUM7SUFFekUsU0FBUyxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ25CLE1BQU0sU0FBUyxHQUFHLE1BQU0sY0FBSSxDQUFDLG1CQUFtQixDQUFDO1lBQy9DLE9BQU8sRUFBRSxDQUFDLHNCQUFTLENBQUM7U0FDckIsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBRWIsR0FBRyxHQUFHLFNBQVMsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQ3hDLE1BQU0sR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRWpCLGtFQUFrRTtRQUNsRSxNQUFNLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxHQUFH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QUUsS0FBSyxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUM7YUFDNUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWYsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsT0FBTyxJQUFJLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFDO0lBQ2xGLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL21hbm55c2FyaW5hbmEvRG93bmxvYWRzL3NvY2lhbC1idXNpbmVzcy1vcy1zY2FmZm9sZC12MC4yL2FwcHMvYXBpL3Rlc3QvZTJlL3Byb2R1Y3RzLmludmVudG9yeS5lMmUtc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBhcHBzL2FwaS90ZXN0L2UyZS9wcm9kdWN0cy5pbnZlbnRvcnkuZTJlLXNwZWMudHNcbmltcG9ydCB7IEFwcE1vZHVsZSB9IGZyb20gJ0AvYXBwLm1vZHVsZSc7XG5pbXBvcnQgeyBJTmVzdEFwcGxpY2F0aW9uIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgVGVzdCB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5pbXBvcnQgcmVxdWVzdCBmcm9tICdzdXBlcnRlc3QnO1xuXG5jb25zdCBPUkcgPSBwcm9jZXNzLmVudi5PUkcgfHwgJ2RlbW8nO1xuY29uc3QgRU1BSUwgPSBwcm9jZXNzLmVudi5BUElfRU1BSUwgfHwgJ3Rlc3RlckBleGFtcGxlLmNvbSc7XG5jb25zdCBQQVNTID0gcHJvY2Vzcy5lbnYuQVBJX1BBU1MgfHwgJ3Bhc3N3b3JkMTIzJztcblxuZGVzY3JpYmUoJ1Byb2R1Y3RzIGludmVudG9yeSAoZTJlKScsICgpID0+IHtcbiAgbGV0IGFwcDogSU5lc3RBcHBsaWNhdGlvbjtcbiAgbGV0IHRva2VuOiBzdHJpbmc7XG5cbiAgY29uc3QgYmFzZSA9ICgpID0+IHJlcXVlc3QoYXBwLmdldEh0dHBTZXJ2ZXIoKSk7XG4gIGNvbnN0IGJhc2VIZWFkZXJzID0geyAneC1vcmcnOiBPUkcsICdjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfTtcblxuICBiZWZvcmVBbGwoYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IG1vZHVsZVJlZiA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG4gICAgICBpbXBvcnRzOiBbQXBwTW9kdWxlXSxcbiAgICB9KS5jb21waWxlKCk7XG5cbiAgICBhcHAgPSBtb2R1bGVSZWYuY3JlYXRlTmVzdEFwcGxpY2F0aW9uKCk7XG4gICAgYXdhaXQgYXBwLmluaXQoKTtcblxuICAgIC8vIFRyeSB0byBlbnN1cmUgdGhlIHVzZXIgZXhpc3RzIChpZGVtcG90ZW50OiAyMDEgb3IgNDA5IGFyZSBva2F5KVxuICAgIGF3YWl0IGJhc2UoKS5wb3N0KCcvYXV0aC9zaWdudXAnKS5zZXQoYmFzZUhlYWRlcnMpLnNlbmQoe1xuICAgICAgZW1haWw6IEVNQUlMLFxuICAgICAgcGFzc3dvcmQ6IFBBU1MsXG4gICAgICBuYW1lOiAnSW52ZW50b3J5IFRlc3RlcicsXG4gICAgfSkub2socmVzID0+IHJlcy5zdGF0dXMgPT09IDIwMSB8fCByZXMuc3RhdHVzID09PSA0MDkpO1xuXG4gICAgLy8gTm93IGxvZ2luIChtdXN0IGJlIDIwMClcbiAgICBjb25zdCBsb2dpbiA9IGF3YWl0IGJhc2UoKVxuICAgICAgLnBvc3QoJy9hdXRoL2xvZ2luJylcbiAgICAgIC5zZXQoYmFzZUhlYWRlcnMpXG4gICAgICAuc2VuZCh7IGVtYWlsOiBFTUFJTCwgcGFzc3dvcmQ6IFBBU1MgfSlcbiAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgIHRva2VuID0gbG9naW4uYm9keT8uYWNjZXNzX3Rva2VuO1xuICAgIGV4cGVjdCh0b2tlbikudG9CZVRydXRoeSgpO1xuICB9KTtcblxuICBhZnRlckFsbChhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgYXBwLmNsb3NlKCk7XG4gIH0pO1xuXG4gIGl0KCdsaXN0cyBwcm9kdWN0cyBhbmQgYWRqdXN0cyBpbnZlbnRvcnkgKzUsIHRoZW4gcmVqZWN0cyBuZWdhdGl2ZSBvdmVyc2hvb3QnLCBhc3luYyAoKSA9PiB7XG4gICAgLy8gMSkgTGlzdCBwcm9kdWN0c1xuICAgIGNvbnN0IGxpc3QgPSBhd2FpdCBiYXNlKCkuZ2V0KCcvcHJvZHVjdHMnKVxuICAgICAgLnNldCh7IC4uLmJhc2VIZWFkZXJzLCBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dG9rZW59YCB9KVxuICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgZXhwZWN0KEFycmF5LmlzQXJyYXkobGlzdC5ib2R5Py5kYXRhKSkudG9CZSh0cnVlKTtcbiAgICBleHBlY3QobGlzdC5ib2R5LmRhdGEubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XG5cbiAgICAvLyBwaWNrIGZpcnN0IGl0ZW0gdGhhdCBoYXMgaW52ZW50b3J5UXR5IGZpZWxkIChhbGwgc2hvdWxkKVxuICAgIGNvbnN0IHByb2R1Y3QgPSBsaXN0LmJvZHkuZGF0YVswXTtcbiAgICBleHBlY3QocHJvZHVjdCkudG9IYXZlUHJvcGVydHkoJ2lkJyk7XG4gICAgZXhwZWN0KHByb2R1Y3QpLnRvSGF2ZVByb3BlcnR5KCdpbnZlbnRvcnlRdHknKTtcblxuICAgIC8vIDIpIEFkanVzdCArNVxuICAgIGNvbnN0IHVwID0gYXdhaXQgYmFzZSgpXG4gICAgICAucG9zdChgL3Byb2R1Y3RzLyR7cHJvZHVjdC5pZH0vaW52ZW50b3J5YClcbiAgICAgIC5zZXQoeyAuLi5iYXNlSGVhZGVycywgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3Rva2VufWAgfSlcbiAgICAgIC5zZW5kKHsgZGVsdGE6IDUgfSlcbiAgICAgIC8vIFNvbWUgaW1wbGVtZW50YXRpb25zIHJldHVybiAyMDEgQ3JlYXRlZCBmb3IgYSBtdXRhdGluZyBhY3Rpb247IGFjY2VwdCAyMDAgb3IgMjAxXG4gICAgICAub2socmVzID0+IHJlcy5zdGF0dXMgPT09IDIwMCB8fCByZXMuc3RhdHVzID09PSAyMDEpO1xuXG4gICAgZXhwZWN0KHVwLmJvZHk/LmludmVudG9yeVF0eSkudG9CZShwcm9kdWN0LmludmVudG9yeVF0eSArIDUpO1xuXG4gICAgLy8gMykgQXR0ZW1wdCBuZWdhdGl2ZSBvdmVyc2hvb3QgKHNob3VsZCA0MDApXG4gICAgY29uc3QgbmVnID0gYXdhaXQgYmFzZSgpXG4gICAgICAucG9zdChgL3Byb2R1Y3RzLyR7cHJvZHVjdC5pZH0vaW52ZW50b3J5YClcbiAgICAgIC5zZXQoeyAuLi5iYXNlSGVhZGVycywgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3Rva2VufWAgfSlcbiAgICAgIC5zZW5kKHsgZGVsdGE6IC0ocHJvZHVjdC5pbnZlbnRvcnlRdHkgKyA2KSB9KVxuICAgICAgLmV4cGVjdCg0MDApO1xuXG4gICAgZXhwZWN0KG5lZy5ib2R5Py5tZXNzYWdlIHx8ICcnKS50b01hdGNoKC8oY2Fubm90fGludmFsaWR8bmVnYXRpdmV8b3ZlcnNob290KS9pKTtcbiAgfSk7XG59KTsiXSwidmVyc2lvbiI6M30=