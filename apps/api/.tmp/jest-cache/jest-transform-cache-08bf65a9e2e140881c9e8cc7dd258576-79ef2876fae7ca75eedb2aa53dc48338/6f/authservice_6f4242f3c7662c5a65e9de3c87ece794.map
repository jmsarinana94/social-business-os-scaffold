{"file":"/Users/mannysarinana/Downloads/social-business-os-scaffold-v0.2/apps/api/src/modules/auth/auth.service.ts","mappings":"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","names":[],"sources":["/Users/mannysarinana/Downloads/social-business-os-scaffold-v0.2/apps/api/src/modules/auth/auth.service.ts"],"sourcesContent":["import { Injectable, UnauthorizedException } from '@nestjs/common';\nimport { JwtService } from '@nestjs/jwt';\nimport * as bcrypt from 'bcryptjs';\nimport { PrismaService } from '../../shared/prisma/prisma.service';\n\nexport interface SignupDto {\n  email: string;\n  password: string;\n  org?: string;\n}\nexport interface LoginDto {\n  email: string;\n  password: string;\n  org?: string;\n}\n\n@Injectable()\nexport class AuthService {\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly jwt: JwtService,\n  ) {}\n\n  async signup(dto: SignupDto) {\n    const orgSlug = dto.org?.trim() || 'demo';\n\n    const org =\n      (await this.prisma.organization.findUnique({ where: { slug: orgSlug } })) ??\n      (await this.prisma.organization.create({\n        data: { slug: orgSlug, name: orgSlug },\n      }));\n\n    const passwordHash = await bcrypt.hash(dto.password, 10);\n\n    const user = await this.prisma.user.create({\n      data: { email: dto.email, password: passwordHash },\n    });\n\n    const existingMember = await this.prisma.orgMember.findFirst({\n      where: { userId: user.id, orgId: org.id },\n    });\n    if (!existingMember) {\n      await this.prisma.orgMember.create({\n        data: { userId: user.id, orgId: org.id, role: 'MEMBER' as any },\n      });\n    }\n\n    return { id: user.id, email: user.email };\n  }\n\n  async login(dto: LoginDto) {\n    const orgSlug = dto.org?.trim() || 'demo';\n    const user = await this.prisma.user.findUnique({\n      where: { email: dto.email },\n    });\n    if (!user) throw new UnauthorizedException('Invalid email or password');\n\n    const ok = await bcrypt.compare(dto.password, user.password);\n    if (!ok) throw new UnauthorizedException('Invalid email or password');\n\n    // Best-effort lastLoginAt; tolerate older DBs without the column\n    try {\n      await this.prisma.user.update({\n        where: { id: user.id },\n        data: { lastLoginAt: new Date() } as any,\n      });\n    } catch {\n      // ignore if column missing\n    }\n\n    await this.prisma.organization.upsert({\n      where: { slug: orgSlug },\n      update: {},\n      create: { slug: orgSlug, name: orgSlug },\n    });\n\n    const payload = { sub: user.id, email: user.email };\n    const access_token = await this.jwt.signAsync(payload);\n    return { access_token };\n  }\n}"],"version":3}