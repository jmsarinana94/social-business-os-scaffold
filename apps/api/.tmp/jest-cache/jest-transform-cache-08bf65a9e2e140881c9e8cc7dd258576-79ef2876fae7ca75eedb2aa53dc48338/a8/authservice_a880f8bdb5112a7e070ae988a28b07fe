70287ddde9b352b1c962c025a01ff0f1
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AuthService = void 0;
const common_1 = require("@nestjs/common");
const jwt_1 = require("@nestjs/jwt");
const bcrypt = __importStar(require("bcrypt"));
const prisma_service_1 = require("../../prisma/prisma.service");
let AuthService = class AuthService {
    constructor(prisma, jwt) {
        this.prisma = prisma;
        this.jwt = jwt;
    }
    jwtSecret() {
        return process.env.JWT_SECRET ?? 'dev-super-secret';
    }
    jwtExpires() {
        return process.env.JWT_EXPIRES_IN ?? '1d';
    }
    async ensureOrg(slug) {
        const s = slug.toLowerCase();
        return this.prisma.organization.upsert({
            where: { slug: s },
            update: {},
            create: { slug: s, name: s },
        });
    }
    signToken(payload) {
        return this.jwt.signAsync(payload, {
            secret: this.jwtSecret(),
            expiresIn: this.jwtExpires(),
        });
    }
    async signup({ org, email, password }) {
        const orgRow = await this.ensureOrg(org);
        const existing = await this.prisma.user.findUnique({ where: { email } });
        if (existing) {
            const token = await this.signToken({
                sub: existing.id,
                email: existing.email,
                orgId: orgRow.id,
            });
            await this.prisma.orgMember.upsert({
                where: { userId_orgId: { userId: existing.id, orgId: orgRow.id } },
                update: {},
                create: { userId: existing.id, orgId: orgRow.id, role: 'MEMBER' },
            });
            return token;
        }
        const saltRounds = Number(process.env.BCRYPT_SALT_ROUNDS ?? 10);
        const hash = await bcrypt.hash(password, saltRounds);
        const user = await this.prisma.user.create({
            data: { email, password: hash },
        });
        await this.prisma.orgMember.upsert({
            where: { userId_orgId: { userId: user.id, orgId: orgRow.id } },
            update: {},
            create: { userId: user.id, orgId: orgRow.id, role: 'MEMBER' },
        });
        return this.signToken({ sub: user.id, email: user.email, orgId: orgRow.id });
    }
    async login({ org, email, password }) {
        const orgRow = await this.ensureOrg(org);
        const user = await this.prisma.user.findUnique({
            where: { email },
        });
        if (!user)
            throw new common_1.UnauthorizedException('Invalid credentials');
        const ok = await bcrypt.compare(password, user.password);
        if (!ok)
            throw new common_1.UnauthorizedException('Invalid credentials');
        await this.prisma.orgMember.upsert({
            where: { userId_orgId: { userId: user.id, orgId: orgRow.id } },
            update: {},
            create: { userId: user.id, orgId: orgRow.id, role: 'MEMBER' },
        });
        return this.signToken({ sub: user.id, email: user.email, orgId: orgRow.id });
    }
    async me({ org, userId, email, }) {
        const where = userId != null
            ? { id: userId }
            : email != null
                ? { email }
                : null;
        if (!where)
            throw new common_1.UnauthorizedException('No user in JWT');
        const user = await this.prisma.user.findUnique({
            where,
            select: { id: true, email: true },
        });
        if (!user)
            throw new common_1.NotFoundException('User not found');
        const orgRow = await this.ensureOrg(org);
        await this.prisma.orgMember.findUniqueOrThrow({
            where: { userId_orgId: { userId: user.id, orgId: orgRow.id } },
        });
        return user;
    }
};
exports.AuthService = AuthService;
exports.AuthService = AuthService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [prisma_service_1.PrismaService,
        jwt_1.JwtService])
], AuthService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hbm55c2FyaW5hbmEvRG93bmxvYWRzL3NvY2lhbC1idXNpbmVzcy1vcy1zY2FmZm9sZC12MC4yL2FwcHMvYXBpL3NyYy9tb2R1bGVzL2F1dGgvYXV0aC5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUl3QjtBQUN4QixxQ0FBeUM7QUFDekMsK0NBQWlDO0FBQ2pDLGdFQUE0RDtBQU1yRCxJQUFNLFdBQVcsR0FBakIsTUFBTSxXQUFXO0lBQ3RCLFlBQ21CLE1BQXFCLEVBQ3JCLEdBQWU7UUFEZixXQUFNLEdBQU4sTUFBTSxDQUFlO1FBQ3JCLFFBQUcsR0FBSCxHQUFHLENBQVk7SUFDL0IsQ0FBQztJQUVJLFNBQVM7UUFDZixPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLGtCQUFrQixDQUFDO0lBQ3RELENBQUM7SUFDTyxVQUFVO1FBQ2hCLE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLElBQUksSUFBSSxDQUFDO0lBQzVDLENBQUM7SUFFTyxLQUFLLENBQUMsU0FBUyxDQUFDLElBQVk7UUFDbEMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQzdCLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDO1lBQ3JDLEtBQUssRUFBRSxFQUFFLElBQUksRUFBRSxDQUFDLEVBQUU7WUFDbEIsTUFBTSxFQUFFLEVBQUU7WUFDVixNQUFNLEVBQUUsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLEVBQUU7U0FDN0IsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLFNBQVMsQ0FBQyxPQUF1RDtRQUN2RSxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRTtZQUNqQyxNQUFNLEVBQUUsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUN4QixTQUFTLEVBQUUsSUFBSSxDQUFD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SUFBSSxDQUFDLFVBQVUsQ0FBQztZQUM3QyxLQUFLO1lBQ0wsTUFBTSxFQUFFLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFO1NBQ2xDLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxJQUFJO1lBQUUsTUFBTSxJQUFJLDBCQUFpQixDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFFekQsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3pDLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQUM7WUFDNUMsS0FBSyxFQUFFLEVBQUUsWUFBWSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRTtTQUMvRCxDQUFDLENBQUM7UUFFSCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7Q0FDRixDQUFBO0FBbEhZLGtDQUFXO3NCQUFYLFdBQVc7SUFEdkIsSUFBQSxtQkFBVSxHQUFFO3FDQUdnQiw4QkFBYTtRQUNoQixnQkFBVTtHQUh2QixXQUFXLENBa0h2QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWFubnlzYXJpbmFuYS9Eb3dubG9hZHMvc29jaWFsLWJ1c2luZXNzLW9zLXNjYWZmb2xkLXYwLjIvYXBwcy9hcGkvc3JjL21vZHVsZXMvYXV0aC9hdXRoLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSW5qZWN0YWJsZSxcbiAgTm90Rm91bmRFeGNlcHRpb24sXG4gIFVuYXV0aG9yaXplZEV4Y2VwdGlvbixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgSnd0U2VydmljZSB9IGZyb20gJ0BuZXN0anMvand0JztcbmltcG9ydCAqIGFzIGJjcnlwdCBmcm9tICdiY3J5cHQnO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJy4uLy4uL3ByaXNtYS9wcmlzbWEuc2VydmljZSc7XG5cbnR5cGUgQ3JlZHMgPSB7IG9yZzogc3RyaW5nOyBlbWFpbDogc3RyaW5nOyBwYXNzd29yZDogc3RyaW5nIH07XG50eXBlIFNpZ251cCA9IENyZWRzO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQXV0aFNlcnZpY2Uge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByaXNtYTogUHJpc21hU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGp3dDogSnd0U2VydmljZSxcbiAgKSB7fVxuXG4gIHByaXZhdGUgand0U2VjcmV0KCkge1xuICAgIHJldHVybiBwcm9jZXNzLmVudi5KV1RfU0VDUkVUID8/ICdkZXYtc3VwZXItc2VjcmV0JztcbiAgfVxuICBwcml2YXRlIGp3dEV4cGlyZXMoKSB7XG4gICAgcmV0dXJuIHByb2Nlc3MuZW52LkpXVF9FWFBJUkVTX0lOID8/ICcxZCc7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGVuc3VyZU9yZyhzbHVnOiBzdHJpbmcpIHtcbiAgICBjb25zdCBzID0gc2x1Zy50b0xvd2VyQ2FzZSgpO1xuICAgIHJldHVybiB0aGlzLnByaXNtYS5vcmdhbml6YXRpb24udXBzZXJ0KHtcbiAgICAgIHdoZXJlOiB7IHNsdWc6IHMgfSxcbiAgICAgIHVwZGF0ZToge30sXG4gICAgICBjcmVhdGU6IHsgc2x1ZzogcywgbmFtZTogcyB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzaWduVG9rZW4ocGF5bG9hZDogeyBzdWI6IHN0cmluZzsgZW1haWw6IHN0cmluZzsgb3JnSWQ/OiBzdHJpbmcgfSkge1xuICAgIHJldHVybiB0aGlzLmp3dC5zaWduQXN5bmMocGF5bG9hZCwge1xuICAgICAgc2VjcmV0OiB0aGlzLmp3dFNlY3JldCgpLFxuICAgICAgZXhwaXJlc0luOiB0aGlzLmp3dEV4cGlyZXMoKSxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIHNpZ251cCh7IG9yZywgZW1haWwsIHBhc3N3b3JkIH06IFNpZ251cCkge1xuICAgIGNvbnN0IG9yZ1JvdyA9IGF3YWl0IHRoaXMuZW5zdXJlT3JnKG9yZyk7XG5cbiAgICBjb25zdCBleGlzdGluZyA9IGF3YWl0IHRoaXMucHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7IHdoZXJlOiB7IGVtYWlsIH0gfSk7XG4gICAgaWYgKGV4aXN0aW5nKSB7XG4gICAgICBjb25zdCB0b2tlbiA9IGF3YWl0IHRoaXMuc2lnblRva2VuKHtcbiAgICAgICAgc3ViOiBleGlzdGluZy5pZCxcbiAgICAgICAgZW1haWw6IGV4aXN0aW5nLmVtYWlsLFxuICAgICAgICBvcmdJZDogb3JnUm93LmlkLFxuICAgICAgfSk7XG4gICAgICBhd2FpdCB0aGlzLnByaXNtYS5vcmdNZW1iZXIudXBzZXJ0KHtcbiAgICAgICAgd2hlcmU6IHsgdXNlcklkX29yZ0lkOiB7IHVzZXJJZDogZXhpc3RpbmcuaWQsIG9yZ0lkOiBvcmdSb3cuaWQgfSB9LFxuICAgICAgICB1cGRhdGU6IHt9LFxuICAgICAgICBjcmVhdGU6IHsgdXNlcklkOiBleGlzdGluZy5pZCwgb3JnSWQ6IG9yZ1Jvdy5pZCwgcm9sZTogJ01FTUJFUicgfSxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHRva2VuO1xuICAgIH1cblxuICAgIGNvbnN0IHNhbHRSb3VuZHMgPSBOdW1iZXIocHJvY2Vzcy5lbnYuQkNSWVBUX1NBTFRfUk9VTkRTID8/IDEwKTtcbiAgICBjb25zdCBoYXNoID0gYXdhaXQgYmNyeXB0Lmhhc2gocGFzc3dvcmQsIHNhbHRSb3VuZHMpO1xuXG4gICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMucHJpc21hLnVzZXIuY3JlYXRlKHtcbiAgICAgIGRhdGE6IHsgZW1haWwsIHBhc3N3b3JkOiBoYXNoIH0sXG4gICAgfSk7XG5cbiAgICBhd2FpdCB0aGlzLnByaXNtYS5vcmdNZW1iZXIudXBzZXJ0KHtcbiAgICAgIHdoZXJlOiB7IHVzZXJJZF9vcmdJZDogeyB1c2VySWQ6IHVzZXIuaWQsIG9yZ0lkOiBvcmdSb3cuaWQgfSB9LFxuICAgICAgdXBkYXRlOiB7fSxcbiAgICAgIGNyZWF0ZTogeyB1c2VySWQ6IHVzZXIuaWQsIG9yZ0lkOiBvcmdSb3cuaWQsIHJvbGU6ICdNRU1CRVInIH0sXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGhpcy5zaWduVG9rZW4oeyBzdWI6IHVzZXIuaWQsIGVtYWlsOiB1c2VyLmVtYWlsLCBvcmdJZDogb3JnUm93LmlkIH0pO1xuICB9XG5cbiAgYXN5bmMgbG9naW4oeyBvcmcsIGVtYWlsLCBwYXNzd29yZCB9OiBDcmVkcykge1xuICAgIGNvbnN0IG9yZ1JvdyA9IGF3YWl0IHRoaXMuZW5zdXJlT3JnKG9yZyk7XG5cbiAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGVtYWlsIH0sXG4gICAgfSk7XG4gICAgaWYgKCF1c2VyKSB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKCdJbnZhbGlkIGNyZWRlbnRpYWxzJyk7XG5cbiAgICBjb25zdCBvayA9IGF3YWl0IGJjcnlwdC5jb21wYXJlKHBhc3N3b3JkLCB1c2VyLnBhc3N3b3JkKTtcbiAgICBpZiAoIW9rKSB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKCdJbnZhbGlkIGNyZWRlbnRpYWxzJyk7XG5cbiAgICBhd2FpdCB0aGlzLnByaXNtYS5vcmdNZW1iZXIudXBzZXJ0KHtcbiAgICAgIHdoZXJlOiB7IHVzZXJJZF9vcmdJZDogeyB1c2VySWQ6IHVzZXIuaWQsIG9yZ0lkOiBvcmdSb3cuaWQgfSB9LFxuICAgICAgdXBkYXRlOiB7fSxcbiAgICAgIGNyZWF0ZTogeyB1c2VySWQ6IHVzZXIuaWQsIG9yZ0lkOiBvcmdSb3cuaWQsIHJvbGU6ICdNRU1CRVInIH0sXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGhpcy5zaWduVG9rZW4oeyBzdWI6IHVzZXIuaWQsIGVtYWlsOiB1c2VyLmVtYWlsLCBvcmdJZDogb3JnUm93LmlkIH0pO1xuICB9XG5cbiAgYXN5bmMgbWUoe1xuICAgIG9yZyxcbiAgICB1c2VySWQsXG4gICAgZW1haWwsXG4gIH06IHtcbiAgICBvcmc6IHN0cmluZztcbiAgICB1c2VySWQ/OiBzdHJpbmc7XG4gICAgZW1haWw/OiBzdHJpbmc7XG4gIH0pIHtcbiAgICBjb25zdCB3aGVyZSA9XG4gICAgICB1c2VySWQgIT0gbnVsbFxuICAgICAgICA/IHsgaWQ6IHVzZXJJZCB9XG4gICAgICAgIDogZW1haWwgIT0gbnVsbFxuICAgICAgICA/IHsgZW1haWwgfVxuICAgICAgICA6IG51bGw7XG5cbiAgICBpZiAoIXdoZXJlKSB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKCdObyB1c2VyIGluIEpXVCcpO1xuXG4gICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMucHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZSxcbiAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSwgZW1haWw6IHRydWUgfSxcbiAgICB9KTtcbiAgICBpZiAoIXVzZXIpIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignVXNlciBub3QgZm91bmQnKTtcblxuICAgIGNvbnN0IG9yZ1JvdyA9IGF3YWl0IHRoaXMuZW5zdXJlT3JnKG9yZyk7XG4gICAgYXdhaXQgdGhpcy5wcmlzbWEub3JnTWVtYmVyLmZpbmRVbmlxdWVPclRocm93KHtcbiAgICAgIHdoZXJlOiB7IHVzZXJJZF9vcmdJZDogeyB1c2VySWQ6IHVzZXIuaWQsIG9yZ0lkOiBvcmdSb3cuaWQgfSB9LFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHVzZXI7XG4gIH1cbn0iXSwidmVyc2lvbiI6M30=