{"file":"/Users/mannysarinana/Downloads/social-business-os-scaffold-v0.2/apps/api/src/modules/auth/auth.service.ts","mappings":"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","names":[],"sources":["/Users/mannysarinana/Downloads/social-business-os-scaffold-v0.2/apps/api/src/modules/auth/auth.service.ts"],"sourcesContent":["import { PrismaService } from '@/infra/prisma/prisma.service';\nimport { Injectable, UnauthorizedException } from '@nestjs/common';\nimport { JwtService } from '@nestjs/jwt';\nimport * as bcrypt from 'bcryptjs';\n\n@Injectable()\nexport class AuthService {\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly jwt: JwtService,\n  ) {}\n\n  async signup(email: string, password: string): Promise<string> {\n    const existing = await this.prisma.user.findUnique({ where: { email } });\n    if (existing) {\n      const ok = await bcrypt.compare(password, existing.password);\n      if (!ok) throw new UnauthorizedException('Invalid email or password');\n      return this.sign(existing.id, existing.email);\n    }\n    const hash = await bcrypt.hash(password, 10);\n    const user = await this.prisma.user.create({\n      data: { email, password: hash },\n      select: { id: true, email: true },\n    });\n    return this.sign(user.id, user.email);\n  }\n\n  /** Returns both token and whether the user was created by this call */\n  async login(email: string, password: string): Promise<{ token: string; created: boolean }> {\n    let created = false;\n\n    let user = await this.prisma.user.findUnique({\n      where: { email },\n      select: { id: true, email: true, password: true },\n    });\n\n    if (!user) {\n      const hash = await bcrypt.hash(password, 10);\n      user = await this.prisma.user.create({\n        data: { email, password: hash },\n        select: { id: true, email: true, password: true },\n      });\n      created = true;\n    } else {\n      const ok = await bcrypt.compare(password, user.password);\n      if (!ok) throw new UnauthorizedException('Invalid email or password');\n    }\n\n    await this.prisma.user.update({\n      where: { id: user.id },\n      data: { lastLoginAt: new Date() },\n    });\n\n    const token = await this.sign(user.id, user.email);\n    return { token, created };\n  }\n\n  private sign(sub: string, email: string) {\n    return this.jwt.signAsync({ sub, email });\n  }\n}"],"version":3}