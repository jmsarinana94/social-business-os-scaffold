{"file":"/Users/mannysarinana/Downloads/social-business-os-scaffold-v0.2/apps/api/src/modules/products/products.service.ts","mappings":"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","names":[],"sources":["/Users/mannysarinana/Downloads/social-business-os-scaffold-v0.2/apps/api/src/modules/products/products.service.ts"],"sourcesContent":["import {\n  BadRequestException,\n  Injectable,\n  NotFoundException,\n} from '@nestjs/common';\nimport { Prisma, ProductStatus, ProductType } from '@prisma/client';\nimport { PrismaService } from '../../shared/prisma/prisma.service';\n\nexport type CreateDto = {\n  sku?: string;\n  title: string;\n  description?: string | null;\n  type: 'PHYSICAL' | 'DIGITAL';\n  status: 'ACTIVE' | 'INACTIVE';\n  price: string;\n};\n\n@Injectable()\nexport class ProductsService {\n  constructor(private readonly prisma: PrismaService) {}\n\n  private async ensureOrg(orgSlug: string) {\n    const org =\n      (await this.prisma.organization.findUnique({\n        where: { slug: orgSlug },\n      })) ??\n      (await this.prisma.organization.create({\n        data: { slug: orgSlug, name: orgSlug },\n      }));\n    return org;\n  }\n\n  private normalizeEnum<T extends string>(\n    value: string,\n    allowed: readonly T[],\n    field: string,\n  ): T {\n    const v = String(value).toUpperCase() as T;\n    if (!allowed.includes(v)) {\n      throw new BadRequestException(\n        `${field} must be one of: ${allowed.join(', ')}`,\n      );\n    }\n    return v;\n  }\n\n  private generateSku(prefix = 'AUTO') {\n    const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';\n    let s = '';\n    for (let i = 0; i < 8; i++) {\n      s += alphabet[Math.floor(Math.random() * alphabet.length)];\n    }\n    return `${prefix}-${s}`;\n  }\n\n  async list(orgSlug: string, page = 1, limit = 10) {\n    const org = await this.ensureOrg(orgSlug);\n    const skip = (page - 1) * limit;\n\n    const [data, total] = await this.prisma.$transaction([\n      this.prisma.product.findMany({\n        where: { orgId: org.id },\n        orderBy: { createdAt: 'desc' },\n        skip,\n        take: limit,\n      }),\n      this.prisma.product.count({ where: { orgId: org.id } }),\n    ]);\n\n    return {\n      data,\n      meta: {\n        page,\n        limit,\n        total,\n        pages: Math.max(1, Math.ceil(total / limit)),\n      },\n    };\n  }\n\n  async get(orgSlug: string, id: string) {\n    const org = await this.ensureOrg(orgSlug);\n    const row = await this.prisma.product.findFirst({\n      where: { id, orgId: org.id },\n    });\n    if (!row) throw new NotFoundException('Product not found');\n    return row;\n  }\n\n  async create(orgSlug: string, dto: CreateDto) {\n    const org = await this.ensureOrg(orgSlug);\n\n    const type = this.normalizeEnum(dto.type, ['PHYSICAL', 'DIGITAL'], 'type') as ProductType;\n    const status = this.normalizeEnum(dto.status, ['ACTIVE', 'INACTIVE'], 'status') as ProductStatus;\n\n    const data: Prisma.ProductCreateInput = {\n      sku: dto.sku ?? this.generateSku('AUTO'),\n      title: dto.title,\n      description: dto.description ?? null,\n      type,\n      status,\n      price: dto.price,\n      org: { connect: { id: org.id } },\n    };\n\n    return this.prisma.product.create({ data });\n  }\n\n  async update(orgSlug: string, id: string, dto: Partial<CreateDto>) {\n    const org = await this.ensureOrg(orgSlug);\n    const existing = await this.prisma.product.findFirst({\n      where: { id, orgId: org.id },\n    });\n    if (!existing) throw new NotFoundException('Product not found');\n\n    const data: Prisma.ProductUpdateInput = {\n      sku: dto.sku ? { set: dto.sku } : undefined,\n      title: dto.title ? { set: dto.title } : undefined,\n      description:\n        dto.description !== undefined ? { set: dto.description } : undefined,\n      type: dto.type\n        ? { set: (this.normalizeEnum(dto.type, ['PHYSICAL', 'DIGITAL'], 'type') as ProductType) }\n        : undefined,\n      status: dto.status\n        ? { set: (this.normalizeEnum(dto.status, ['ACTIVE', 'INACTIVE'], 'status') as ProductStatus) }\n        : undefined,\n      price: dto.price ? { set: dto.price } : undefined,\n    };\n\n    return this.prisma.product.update({\n      where: { id },\n      data,\n    });\n  }\n\n  async remove(orgSlug: string, id: string) {\n    const org = await this.ensureOrg(orgSlug);\n    const existing = await this.prisma.product.findFirst({\n      where: { id, orgId: org.id },\n    });\n    if (!existing) throw new NotFoundException('Product not found');\n\n    await this.prisma.product.delete({ where: { id } });\n    return { ok: true };\n  }\n\n  async getInventory(orgSlug: string, id: string) {\n    const org = await this.ensureOrg(orgSlug);\n    const row = await this.prisma.product.findFirst({\n      where: { id, orgId: org.id },\n      select: { id: true, inventoryQty: true },\n    });\n    if (!row) throw new NotFoundException('Product not found');\n    return row;\n  }\n\n  // kept for compatibility if any caller still uses readInventory()\n  async readInventory(orgSlug: string, id: string) {\n    return this.getInventory(orgSlug, id);\n  }\n\n  async adjustInventory(orgSlug: string, id: string, delta: number) {\n    const org = await this.ensureOrg(orgSlug);\n    const product = await this.prisma.product.findFirst({\n      where: { id, orgId: org.id },\n      select: { id: true, inventoryQty: true },\n    });\n    if (!product) throw new NotFoundException('Product not found');\n\n    const next = (product.inventoryQty ?? 0) + Number(delta);\n    if (next < 0) {\n      throw new BadRequestException('Inventory cannot go negative');\n    }\n\n    return this.prisma.product.update({\n      where: { id },\n      data: { inventoryQty: next },\n    });\n  }\n}"],"version":3}