{"file":"/Users/mannysarinana/Downloads/social-business-os-scaffold-v0.2/apps/api/src/modules/auth/auth.service.ts","mappings":"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","names":[],"sources":["/Users/mannysarinana/Downloads/social-business-os-scaffold-v0.2/apps/api/src/modules/auth/auth.service.ts"],"sourcesContent":["import { Injectable, UnauthorizedException } from '@nestjs/common';\nimport { JwtService } from '@nestjs/jwt';\nimport * as bcrypt from 'bcrypt';\n\nimport { PrismaService } from '../../shared/prisma/prisma.service';\n\ntype Creds = {\n  org: string;\n  email: string;\n  password: string;\n};\n\n@Injectable()\nexport class AuthService {\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly jwt: JwtService,\n  ) {}\n\n  /**\n   * Ensure org + user exist and are associated, then return a JWT.\n   */\n  async signup({ org, email, password }: Creds) {\n    // 1) Ensure organization exists (slug=name for now)\n    const orgRow =\n      (await this.prisma.organization?.findUnique?.({ where: { slug: org } })) ||\n      (await this.prisma.organization?.create?.({\n        data: { slug: org, name: org },\n      }));\n\n    // 2) Upsert user with hashed password\n    const hash = await bcrypt.hash(password, Number(process.env.BCRYPT_SALT_ROUNDS ?? 10));\n    const user =\n      (await this.prisma.user.findUnique({ where: { email } })) ??\n      (await this.prisma.user.create({\n        data: { email, password: hash },\n      }));\n\n    // 3) If user existed, make sure password is set (idempotent)\n    if (user.password !== hash) {\n      await this.prisma.user.update({\n        where: { id: user.id },\n        data: { password: hash },\n      });\n    }\n\n    // 4) Ensure membership exists (ignore if already there)\n    try {\n      // Prefer a composite unique (userId, orgId) if present; otherwise create blindly.\n      await this.prisma.orgMember.create({\n        data: { userId: user.id, orgId: orgRow.id, role: 'MEMBER' as any },\n      });\n    } catch {\n      // Likely unique violation or already exists — ignore to stay idempotent.\n    }\n\n    // 5) Issue JWT\n    const access_token = await this.jwt.signAsync(\n      { sub: user.id, email },\n      {\n        secret: process.env.JWT_SECRET || 'dev-secret',\n        expiresIn: process.env.JWT_EXPIRES_IN || '1h',\n      },\n    );\n\n    return { access_token };\n  }\n\n  /**\n   * Validate user, stamp lastLoginAt, return JWT.\n   */\n  async login({ org, email, password }: Creds) {\n    // org is currently not required for validation beyond header presence,\n    // but we keep it to match controller signature and future org scoping.\n    const user = await this.prisma.user.findUnique({ where: { email } });\n    if (!user) throw new UnauthorizedException('Invalid email or password');\n\n    const ok = await bcrypt.compare(password, user.password);\n    if (!ok) throw new UnauthorizedException('Invalid email or password');\n\n    // Stamp lastLoginAt if column exists (safe-guard try/catch to avoid breaking if schema drifts)\n    try {\n      await this.prisma.user.update({\n        where: { id: user.id },\n        data: { lastLoginAt: new Date() as any },\n      });\n    } catch {\n      // Column not present in this DB — ignore.\n    }\n\n    const access_token = await this.jwt.signAsync(\n      { sub: user.id, email: user.email },\n      {\n        secret: process.env.JWT_SECRET || 'dev-secret',\n        expiresIn: process.env.JWT_EXPIRES_IN || '1h',\n      },\n    );\n\n    return { access_token };\n  }\n}\n\nexport default AuthService; // ← default export too"],"version":3}