db917f78a125e656e2487c8476479dd2
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const supertest_1 = __importDefault(require("supertest"));
const app_module_1 = require("../../src/app.module");
const auth_module_1 = require("../../src/modules/auth/auth.module");
describe('Products (e2e)', () => {
    let app;
    const ORG = 'demo';
    const baseHeaders = { 'x-org': ORG };
    beforeAll(async () => {
        const moduleRef = await testing_1.Test.createTestingModule({
            imports: [app_module_1.AppModule, auth_module_1.AuthModule], // ðŸ‘ˆ add this
        }).compile();
        app = moduleRef.createNestApplication();
        await app.init();
    });
    afterAll(async () => {
        await app.close();
    });
    it('GET /products returns paginated list', async () => {
        const email = `p_${Date.now()}@ex.com`;
        const password = 'secret123';
        await (0, supertest_1.default)(app.getHttpServer())
            .post('/auth/signup')
            .set(baseHeaders)
            .send({ email, password, name: 'Tester' })
            .expect(201);
        const login = await (0, supertest_1.default)(app.getHttpServer())
            .post('/auth/login')
            .set(baseHeaders)
            .send({ email, password })
            .expect(200);
        const token = login.body?.access_token || 'test-token';
        const headers = { ...baseHeaders, Authorization: `Bearer ${token}` };
        await (0, supertest_1.default)(app.getHttpServer())
            .get('/products?page=1&limit=5')
            .set(headers)
            .expect(200);
    });
    it('POST -> GET -> PUT (partial) -> DELETE', async () => {
        const email = `pp_${Date.now()}@ex.com`;
        const password = 'secret123';
        await (0, supertest_1.default)(app.getHttpServer())
            .post('/auth/signup')
            .set(baseHeaders)
            .send({ email, password, name: 'Tester' })
            .expect(201);
        const login = await (0, supertest_1.default)(app.getHttpServer())
            .post('/auth/login')
            .set(baseHeaders)
            .send({ email, password })
            .expect(200);
        const token = login.body?.access_token || 'test-token';
        const headers = { ...baseHeaders, Authorization: `Bearer ${token}` };
        const createRes = await (0, supertest_1.default)(app.getHttpServer())
            .post('/products')
            .set(headers)
            .send({ title: 'Widget', type: 'physical', status: 'active', price: 12, description: 'Test' })
            .expect(201);
        const id = createRes.body.id ?? createRes.body.data?.id;
        await (0, supertest_1.default)(app.getHttpServer()).get(`/products/${id}`).set(headers).expect(200);
        await (0, supertest_1.default)(app.getHttpServer()).put(`/products/${id}`).set(headers).send({ price: 20 }).expect(200);
        await (0, supertest_1.default)(app.getHttpServer()).delete(`/products/${id}`).set(headers).expect(200);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hbm55c2FyaW5hbmEvRG93bmxvYWRzL3NvY2lhbC1idXNpbmVzcy1vcy1zY2FmZm9sZC12MC4yL2FwcHMvYXBpL3Rlc3QvZTJlL3Byb2R1Y3RzLmUyZS1zcGVjLnRzIiwibWFwcGluZ3MiOiI7Ozs7O0FBQ0EsNkNBQXVDO0FBQ3ZDLDBEQUFnQztBQUNoQyxxREFBaUQ7QUFDakQsb0VBQWdFO0FBRWhFLFFBQVEsQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLEVBQUU7SUFDOUIsSUFBSSxHQUFxQixDQUFDO0lBRTFCLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQztJQUNuQixNQUFNLFdBQVcsR0FBRyxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FBQztJQUVyQyxTQUFTLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDbkIsTUFBTSxTQUFTLEdBQUcsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDL0MsT0FBTyxFQUFFLENBQUMsc0JBQVMsRUFBRSx3QkFBVSxDQUFDLEVBQUUsY0FBYztTQUNqRCxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFYixHQUFHLEdBQUcsU0FBUyxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFDeEMsTUFBTSxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDbkIsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDbEIsTUFBTSxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDcEIsQ0FBQyxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsc0NBQXNDLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFDcEQsTUFBTSxLQUFLLEdBQUcsS0FBSyxJQUFJLENBQUMsR0FBRyxFQUFFLFNBQVMsQ0FBQztRQUN2QyxNQUFNLFFBQVEsR0FBRyxXQUFXLENBQUM7UUFFN0IsTUFBTSxJQUFBLG1CQUFPLEVBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxDQUFDO2FBQy9CLElBQUksQ0FBQyxjQUFjLENBQUM7YUFDcEIsR0FBRyxDQUFDLFdBQVcsQ0FBQzthQUNoQixJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsQ0FBQzthQUN6QyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFZixNQUFNLEtBQUssR0FBRyxNQUFNLElBQUEsbUJBQU8sRUFBQyxHQUFHLENBQUMsYUFBYSxFQUFFLENBQUM7YUFDN0MsSUFBSSxDQUFDLGFBQWEsQ0FBQzthQUNuQixHQUFHLENBQUMsV0FBVyxDQUFDO2FBQ2hCLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsQ0FBQzthQUN6QixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFZixNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsSUFBSSxFQUFFLFlBQVksSUFBSSxZQUFZLENBQUM7UUFDdkQsTUFBTSxPQUFPLEdBQUcsRUFBRSxHQUFHLFdBQVcsRUFBRSxhQUFhLEVBQUUsVUFBVSxLQUFLLEVBQUUsRUFBRSxDQUFDO1FBRXJFLE1BQU0sSUFBQSxtQkFBTyxFQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsQ0FBQzthQUMvQixHQUFHLENBQUMsMEJBQTBCLENBQUM7YUFDL0IsR0FBRyxDQUFDLE9BQU8sQ0FBQzthQUNaLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNqQixDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyx3Q0FBd0MsRUFBRSxLQUFLLElBQUksRUFBRTtRQUN0RCxNQUFNLEtBQUssR0FBRyxNQUFNLElBQUksQ0FBQyxHQUFHLEVBQUUsU0FBUyxDQUFDO1FBQ3hDLE1BQU0sUUFBUSxHQUFHLFdBQVcsQ0FBQztRQUU3QixNQUFNLElBQUEsbUJBQU8sRUFBQyxHQUFHLENBQUMsYUFBYSxFQUFFLENBQUM7YUFDL0IsSUFBSSxDQUFDLGNBQWMsQ0FBQzthQUNwQixHQUFHLENBQUMsV0FBVyxDQUFDO2FBQ2hCLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxDQUFDO2FBQ3pDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUVmLE1BQU0sS0FBSyxHQUFHLE1BQU0sSUFBQSxtQkFBTyxFQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsQ0FBQzthQUM3QyxJQUFJLENBQUMsYUFBYSxDQUFDO2FBQ25CLEdBQUcsQ0FBQyxXQUFXLENBQUM7YUFDaEIsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxDQUFDO2FBQ3pCLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUVmLE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLEVBQUUsWUFBWSxJQUFJLFlBQVksQ0FBQztRQUN2RCxNQUFNLE9BQU8sR0FBRyxFQUFFLEdBQUcsV0FBVyxFQUFFLGFBQWEsRUFBRSxVQUFVLEtBQUssRUFBRSxFQUFFLENBQUM7UUFFckUsTUFBTSxTQUFTLEdBQUcsTUFBTSxJQUFBLG1CQUFPLEVBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxDQUFDO2FBQ2pELElBQUksQ0FBQyxXQUFXLENBQUM7YUFDakIsR0FBRyxDQUFDLE9BQU8sQ0FBQzthQUNaLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRSxDQUFDO2FBQzdGLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUVmLE1BQU0sRUFBRSxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQztRQUV4RCxNQUFNLElBQUEsbUJBQU8sRUFBQyxHQUFHLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbkYsTUFBTSxJQUFBLG1CQUFPLEVBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3ZHLE1BQU0sSUFBQSxtQkFBTyxFQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxhQUFhLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN4RixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9tYW5ueXNhcmluYW5hL0Rvd25sb2Fkcy9zb2NpYWwtYnVzaW5lc3Mtb3Mtc2NhZmZvbGQtdjAuMi9hcHBzL2FwaS90ZXN0L2UyZS9wcm9kdWN0cy5lMmUtc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJTmVzdEFwcGxpY2F0aW9uIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgVGVzdCB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5pbXBvcnQgcmVxdWVzdCBmcm9tICdzdXBlcnRlc3QnO1xuaW1wb3J0IHsgQXBwTW9kdWxlIH0gZnJvbSAnLi4vLi4vc3JjL2FwcC5tb2R1bGUnO1xuaW1wb3J0IHsgQXV0aE1vZHVsZSB9IGZyb20gJy4uLy4uL3NyYy9tb2R1bGVzL2F1dGgvYXV0aC5tb2R1bGUnO1xuXG5kZXNjcmliZSgnUHJvZHVjdHMgKGUyZSknLCAoKSA9PiB7XG4gIGxldCBhcHA6IElOZXN0QXBwbGljYXRpb247XG5cbiAgY29uc3QgT1JHID0gJ2RlbW8nO1xuICBjb25zdCBiYXNlSGVhZGVycyA9IHsgJ3gtb3JnJzogT1JHIH07XG5cbiAgYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb2R1bGVSZWYgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgaW1wb3J0czogW0FwcE1vZHVsZSwgQXV0aE1vZHVsZV0sIC8vIPCfkYggYWRkIHRoaXNcbiAgICB9KS5jb21waWxlKCk7XG5cbiAgICBhcHAgPSBtb2R1bGVSZWYuY3JlYXRlTmVzdEFwcGxpY2F0aW9uKCk7XG4gICAgYXdhaXQgYXBwLmluaXQoKTtcbiAgfSk7XG5cbiAgYWZ0ZXJBbGwoYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IGFwcC5jbG9zZSgpO1xuICB9KTtcblxuICBpdCgnR0VUIC9wcm9kdWN0cyByZXR1cm5zIHBhZ2luYXRlZCBsaXN0JywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGVtYWlsID0gYHBfJHtEYXRlLm5vdygpfUBleC5jb21gO1xuICAgIGNvbnN0IHBhc3N3b3JkID0gJ3NlY3JldDEyMyc7XG5cbiAgICBhd2FpdCByZXF1ZXN0KGFwcC5nZXRIdHRwU2VydmVyKCkpXG4gICAgICAucG9zdCgnL2F1dGgvc2lnbnVwJylcbiAgICAgIC5zZXQoYmFzZUhlYWRlcnMpXG4gICAgICAuc2VuZCh7IGVtYWlsLCBwYXNzd29yZCwgbmFtZTogJ1Rlc3RlcicgfSlcbiAgICAgIC5leHBlY3QoMjAxKTtcblxuICAgIGNvbnN0IGxvZ2luID0gYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgLnBvc3QoJy9hdXRoL2xvZ2luJylcbiAgICAgIC5zZXQoYmFzZUhlYWRlcnMpXG4gICAgICAuc2VuZCh7IGVtYWlsLCBwYXNzd29yZCB9KVxuICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgY29uc3QgdG9rZW4gPSBsb2dpbi5ib2R5Py5hY2Nlc3NfdG9rZW4gfHwgJ3Rlc3QtdG9rZW4nO1xuICAgIGNvbnN0IGhlYWRlcnMgPSB7IC4uLmJhc2VIZWFkZXJzLCBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dG9rZW59YCB9O1xuXG4gICAgYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgLmdldCgnL3Byb2R1Y3RzP3BhZ2U9MSZsaW1pdD01JylcbiAgICAgIC5zZXQoaGVhZGVycylcbiAgICAgIC5leHBlY3QoMjAwKTtcbiAgfSk7XG5cbiAgaXQoJ1BPU1QgLT4gR0VUIC0+IFBVVCAocGFydGlhbCkgLT4gREVMRVRFJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGVtYWlsID0gYHBwXyR7RGF0ZS5ub3coKX1AZXguY29tYDtcbiAgICBjb25zdCBwYXNzd29yZCA9ICdzZWNyZXQxMjMnO1xuXG4gICAgYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgLnBvc3QoJy9hdXRoL3NpZ251cCcpXG4gICAgICAuc2V0KGJhc2VIZWFkZXJzKVxuICAgICAgLnNlbmQoeyBlbWFpbCwgcGFzc3dvcmQsIG5hbWU6ICdUZXN0ZXInIH0pXG4gICAgICAuZXhwZWN0KDIwMSk7XG5cbiAgICBjb25zdCBsb2dpbiA9IGF3YWl0IHJlcXVlc3QoYXBwLmdldEh0dHBTZXJ2ZXIoKSlcbiAgICAgIC5wb3N0KCcvYXV0aC9sb2dpbicpXG4gICAgICAuc2V0KGJhc2VIZWFkZXJzKVxuICAgICAgLnNlbmQoeyBlbWFpbCwgcGFzc3dvcmQgfSlcbiAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgIGNvbnN0IHRva2VuID0gbG9naW4uYm9keT8uYWNjZXNzX3Rva2VuIHx8ICd0ZXN0LXRva2VuJztcbiAgICBjb25zdCBoZWFkZXJzID0geyAuLi5iYXNlSGVhZGVycywgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3Rva2VufWAgfTtcblxuICAgIGNvbnN0IGNyZWF0ZVJlcyA9IGF3YWl0IHJlcXVlc3QoYXBwLmdldEh0dHBTZXJ2ZXIoKSlcbiAgICAgIC5wb3N0KCcvcHJvZHVjdHMnKVxuICAgICAgLnNldChoZWFkZXJzKVxuICAgICAgLnNlbmQoeyB0aXRsZTogJ1dpZGdldCcsIHR5cGU6ICdwaHlzaWNhbCcsIHN0YXR1czogJ2FjdGl2ZScsIHByaWNlOiAxMiwgZGVzY3JpcHRpb246ICdUZXN0JyB9KVxuICAgICAgLmV4cGVjdCgyMDEpO1xuXG4gICAgY29uc3QgaWQgPSBjcmVhdGVSZXMuYm9keS5pZCA/PyBjcmVhdGVSZXMuYm9keS5kYXRhPy5pZDtcblxuICAgIGF3YWl0IHJlcXVlc3QoYXBwLmdldEh0dHBTZXJ2ZXIoKSkuZ2V0KGAvcHJvZHVjdHMvJHtpZH1gKS5zZXQoaGVhZGVycykuZXhwZWN0KDIwMCk7XG4gICAgYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKS5wdXQoYC9wcm9kdWN0cy8ke2lkfWApLnNldChoZWFkZXJzKS5zZW5kKHsgcHJpY2U6IDIwIH0pLmV4cGVjdCgyMDApO1xuICAgIGF3YWl0IHJlcXVlc3QoYXBwLmdldEh0dHBTZXJ2ZXIoKSkuZGVsZXRlKGAvcHJvZHVjdHMvJHtpZH1gKS5zZXQoaGVhZGVycykuZXhwZWN0KDIwMCk7XG4gIH0pO1xufSk7Il0sInZlcnNpb24iOjN9