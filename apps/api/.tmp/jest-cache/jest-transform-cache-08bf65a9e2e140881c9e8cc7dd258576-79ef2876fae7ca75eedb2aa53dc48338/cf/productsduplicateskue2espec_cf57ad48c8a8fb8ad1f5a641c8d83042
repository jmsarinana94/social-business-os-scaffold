10fda24daea02c985f66481fa9030b8f
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
// apps/api/test/e2e/products.duplicate-sku.e2e-spec.ts
const app_module_1 = require("@/app.module");
const testing_1 = require("@nestjs/testing");
const supertest_1 = __importDefault(require("supertest"));
describe('Products duplicate SKU (e2e)', () => {
    let app;
    const baseHeaders = { 'x-org': 'demo' };
    const email = 'dup-sku@demo.io';
    const password = 'pass123';
    beforeAll(async () => {
        const moduleRef = await testing_1.Test.createTestingModule({
            imports: [app_module_1.AppModule],
        }).compile();
        app = moduleRef.createNestApplication();
        await app.init();
        await (0, supertest_1.default)(app.getHttpServer())
            .post('/auth/signup')
            .set(baseHeaders)
            .send({ email, password, name: 'Dup Tester' })
            .expect(201);
        await (0, supertest_1.default)(app.getHttpServer())
            .post('/auth/login')
            .send({ email, password })
            .expect(200);
    });
    afterAll(async () => {
        await app.close();
    });
    it('201 then 409 for same SKU in same org', async () => {
        const login = await (0, supertest_1.default)(app.getHttpServer())
            .post('/auth/login')
            .send({ email, password })
            .expect(200);
        const token = login.body?.access_token;
        const headers = { ...baseHeaders, Authorization: `Bearer ${token}` };
        const payload = {
            sku: 'DUP-001',
            title: 'Widget',
            type: 'PHYSICAL',
            status: 'ACTIVE',
            price: '1.00',
        };
        await (0, supertest_1.default)(app.getHttpServer()).post('/products').set(headers).send(payload).expect(201);
        await (0, supertest_1.default)(app.getHttpServer()).post('/products').set(headers).send(payload).expect(409);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hbm55c2FyaW5hbmEvRG93bmxvYWRzL3NvY2lhbC1idXNpbmVzcy1vcy1zY2FmZm9sZC12MC4yL2FwcHMvYXBpL3Rlc3QvZTJlL3Byb2R1Y3RzLmR1cGxpY2F0ZS1za3UuZTJlLXNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSx1REFBdUQ7QUFDdkQsNkNBQXlDO0FBRXpDLDZDQUF1QztBQUN2QywwREFBZ0M7QUFFaEMsUUFBUSxDQUFDLDhCQUE4QixFQUFFLEdBQUcsRUFBRTtJQUM1QyxJQUFJLEdBQXFCLENBQUM7SUFDMUIsTUFBTSxXQUFXLEdBQUcsRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLENBQUM7SUFDeEMsTUFBTSxLQUFLLEdBQUcsaUJBQWlCLENBQUM7SUFDaEMsTUFBTSxRQUFRLEdBQUcsU0FBUyxDQUFDO0lBRTNCLFNBQVMsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNuQixNQUFNLFNBQVMsR0FBRyxNQUFNLGNBQUksQ0FBQyxtQkFBbUIsQ0FBQztZQUMvQyxPQUFPLEVBQUUsQ0FBQyxzQkFBUyxDQUFDO1NBQ3JCLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUViLEdBQUcsR0FBRyxTQUFTLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUN4QyxNQUFNLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUVqQixNQUFNLElBQUEsbUJBQU8sRUFBQyxHQUFHLENBQUMsYUFBYSxFQUFFLENBQUM7YUFDL0IsSUFBSSxDQUFDLGNBQWMsQ0FBQzthQUNwQixHQUFHLENBQUMsV0FBVyxDQUFDO2FBQ2hCLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxDQUFDO2FBQzdDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUVmLE1BQU0sSUFBQSxtQkFBTyxFQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsQ0FBQzthQUMvQixJQUFJLENBQUMsYUFBYSxDQUFDO2FBQ25CLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsQ0FBQzthQUN6QixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDakIsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDbEIsTUFBTSxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDcEIsQ0FBQyxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsdUNBQXVDLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFDckQsTUFBTSxLQUFLLEdBQUcsTUFBTSxJQUFBLG1CQUFPLEVBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxDQUFDO2FBQzdDLElBQUksQ0FBQyxhQUFhLENBQUM7YUFDbkIsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxDQUFDO2FBQ3pCLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUVmLE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLEVBQUUsWUFBWSxDQUFDO1FBQ3ZDLE1BQU0sT0FBTyxHQUFHLEVBQUUsR0FBRyxXQUFXLEVBQUUsYUFBYSxFQUFFLFVBQVUsS0FBSyxFQUFFLEVBQUUsQ0FBQztRQUVyRSxNQUFNLE9BQU8sR0FBRztZQUNkLEdBQUcsRUFBRSxTQUFTO1lBQ2QsS0FBSyxFQUFFLFFBQVE7WUFDZixJQUFJLEVBQUUsVUFBVTtZQUNoQixNQUFNLEVBQUUsUUFBUTtZQUNoQixLQUFLLEVBQUUsTUFBTTtTQUNkLENBQUM7UUFFRixNQUFNLElBQUEsbUJBQU8sRUFBQyxHQUFHLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDNUYsTUFBTSxJQUFBLG1CQUFPLEVBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzlGLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL21hbm55c2FyaW5hbmEvRG93bmxvYWRzL3NvY2lhbC1idXNpbmVzcy1vcy1zY2FmZm9sZC12MC4yL2FwcHMvYXBpL3Rlc3QvZTJlL3Byb2R1Y3RzLmR1cGxpY2F0ZS1za3UuZTJlLXNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gYXBwcy9hcGkvdGVzdC9lMmUvcHJvZHVjdHMuZHVwbGljYXRlLXNrdS5lMmUtc3BlYy50c1xuaW1wb3J0IHsgQXBwTW9kdWxlIH0gZnJvbSAnQC9hcHAubW9kdWxlJztcbmltcG9ydCB7IElOZXN0QXBwbGljYXRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBUZXN0IH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCByZXF1ZXN0IGZyb20gJ3N1cGVydGVzdCc7XG5cbmRlc2NyaWJlKCdQcm9kdWN0cyBkdXBsaWNhdGUgU0tVIChlMmUpJywgKCkgPT4ge1xuICBsZXQgYXBwOiBJTmVzdEFwcGxpY2F0aW9uO1xuICBjb25zdCBiYXNlSGVhZGVycyA9IHsgJ3gtb3JnJzogJ2RlbW8nIH07XG4gIGNvbnN0IGVtYWlsID0gJ2R1cC1za3VAZGVtby5pbyc7XG4gIGNvbnN0IHBhc3N3b3JkID0gJ3Bhc3MxMjMnO1xuXG4gIGJlZm9yZUFsbChhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgbW9kdWxlUmVmID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIGltcG9ydHM6IFtBcHBNb2R1bGVdLFxuICAgIH0pLmNvbXBpbGUoKTtcblxuICAgIGFwcCA9IG1vZHVsZVJlZi5jcmVhdGVOZXN0QXBwbGljYXRpb24oKTtcbiAgICBhd2FpdCBhcHAuaW5pdCgpO1xuXG4gICAgYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgLnBvc3QoJy9hdXRoL3NpZ251cCcpXG4gICAgICAuc2V0KGJhc2VIZWFkZXJzKVxuICAgICAgLnNlbmQoeyBlbWFpbCwgcGFzc3dvcmQsIG5hbWU6ICdEdXAgVGVzdGVyJyB9KVxuICAgICAgLmV4cGVjdCgyMDEpO1xuXG4gICAgYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgLnBvc3QoJy9hdXRoL2xvZ2luJylcbiAgICAgIC5zZW5kKHsgZW1haWwsIHBhc3N3b3JkIH0pXG4gICAgICAuZXhwZWN0KDIwMCk7XG4gIH0pO1xuXG4gIGFmdGVyQWxsKGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCBhcHAuY2xvc2UoKTtcbiAgfSk7XG5cbiAgaXQoJzIwMSB0aGVuIDQwOSBmb3Igc2FtZSBTS1UgaW4gc2FtZSBvcmcnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgbG9naW4gPSBhd2FpdCByZXF1ZXN0KGFwcC5nZXRIdHRwU2VydmVyKCkpXG4gICAgICAucG9zdCgnL2F1dGgvbG9naW4nKVxuICAgICAgLnNlbmQoeyBlbWFpbCwgcGFzc3dvcmQgfSlcbiAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgIGNvbnN0IHRva2VuID0gbG9naW4uYm9keT8uYWNjZXNzX3Rva2VuO1xuICAgIGNvbnN0IGhlYWRlcnMgPSB7IC4uLmJhc2VIZWFkZXJzLCBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dG9rZW59YCB9O1xuXG4gICAgY29uc3QgcGF5bG9hZCA9IHtcbiAgICAgIHNrdTogJ0RVUC0wMDEnLFxuICAgICAgdGl0bGU6ICdXaWRnZXQnLFxuICAgICAgdHlwZTogJ1BIWVNJQ0FMJyxcbiAgICAgIHN0YXR1czogJ0FDVElWRScsXG4gICAgICBwcmljZTogJzEuMDAnLFxuICAgIH07XG5cbiAgICBhd2FpdCByZXF1ZXN0KGFwcC5nZXRIdHRwU2VydmVyKCkpLnBvc3QoJy9wcm9kdWN0cycpLnNldChoZWFkZXJzKS5zZW5kKHBheWxvYWQpLmV4cGVjdCgyMDEpO1xuICAgIGF3YWl0IHJlcXVlc3QoYXBwLmdldEh0dHBTZXJ2ZXIoKSkucG9zdCgnL3Byb2R1Y3RzJykuc2V0KGhlYWRlcnMpLnNlbmQocGF5bG9hZCkuZXhwZWN0KDQwOSk7XG4gIH0pO1xufSk7Il0sInZlcnNpb24iOjN9