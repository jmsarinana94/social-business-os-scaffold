{"file":"/Users/mannysarinana/Downloads/social-business-os-scaffold-v0.2/apps/api/src/modules/products/products.service.ts","mappings":"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","names":[],"sources":["/Users/mannysarinana/Downloads/social-business-os-scaffold-v0.2/apps/api/src/modules/products/products.service.ts"],"sourcesContent":["import {\n  BadRequestException,\n  ConflictException,\n  Injectable,\n  NotFoundException,\n} from '@nestjs/common';\nimport { Prisma, ProductStatus, ProductType } from '@prisma/client';\nimport { PrismaService } from '../../infra/prisma/prisma.service';\nimport { CreateProductDto } from './dto/create-product.dto';\nimport { UpdateProductDto } from './dto/update-product.dto';\n\ntype JsonSafeProduct = {\n  id: string;\n  orgId: string;\n  sku: string;\n  title: string;\n  type: ProductType;\n  status: ProductStatus;\n  price: string | null; // serialize Decimal to string\n  description: string | null;\n  inventoryQty: number;\n  createdAt: string; // ISO string for transport\n  updatedAt: string; // ISO string for transport\n};\n\n@Injectable()\nexport class ProductsService {\n  constructor(private readonly prisma: PrismaService) {}\n\n  private async getOrgIdFromSlug(orgSlug?: string): Promise<string> {\n    if (!orgSlug) throw new BadRequestException('x-org header required');\n    const org = await this.prisma.organization.findUnique({\n      where: { slug: orgSlug },\n      select: { id: true },\n    });\n    if (!org) throw new BadRequestException(`Unknown org: ${orgSlug}`);\n    return org.id;\n  }\n\n  private serializeOne(p: {\n    id: string;\n    orgId: string;\n    sku: string;\n    title: string;\n    type: ProductType;\n    status: ProductStatus;\n    price: Prisma.Decimal | null;\n    description: string | null;\n    inventoryQty: number;\n    createdAt: Date;\n    updatedAt: Date;\n  }): JsonSafeProduct {\n    return {\n      id: p.id,\n      orgId: p.orgId,\n      sku: p.sku,\n      title: p.title,\n      type: p.type,\n      status: p.status,\n      // ensure JSON-safe (avoid Decimal object in response)\n      price: p.price === null ? null : p.price.toString(),\n      description: p.description,\n      inventoryQty: p.inventoryQty,\n      createdAt: p.createdAt.toISOString(),\n      updatedAt: p.updatedAt.toISOString(),\n    };\n  }\n\n  async list(orgSlug: string, page = 1, limit = 10) {\n    const orgId = await this.getOrgIdFromSlug(orgSlug);\n\n    const [rows, total] = await this.prisma.$transaction([\n      this.prisma.product.findMany({\n        where: { orgId },\n        orderBy: { createdAt: 'desc' },\n        skip: (page - 1) * limit,\n        take: limit,\n        select: {\n          id: true,\n          orgId: true,\n          sku: true,\n          title: true,\n          type: true,\n          status: true,\n          price: true, // Prisma.Decimal | null\n          description: true,\n          inventoryQty: true,\n          createdAt: true,\n          updatedAt: true,\n        },\n      }),\n      this.prisma.product.count({ where: { orgId } }),\n    ]);\n\n    const data = rows.map((p) => this.serializeOne(p));\n\n    return {\n      data,\n      meta: {\n        page,\n        limit,\n        total,\n        pages: Math.max(1, Math.ceil(total / limit)),\n      },\n    };\n  }\n\n  async get(orgSlug: string, id: string) {\n    const orgId = await this.getOrgIdFromSlug(orgSlug);\n    const p = await this.prisma.product.findFirst({\n      where: { id, orgId },\n      select: {\n        id: true,\n        orgId: true,\n        sku: true,\n        title: true,\n        type: true,\n        status: true,\n        price: true,\n        description: true,\n        inventoryQty: true,\n        createdAt: true,\n        updatedAt: true,\n      },\n    });\n    if (!p) throw new NotFoundException('Product not found');\n    return this.serializeOne(p);\n  }\n\n  async create(orgSlug: string, dto: CreateProductDto) {\n    const orgId = await this.getOrgIdFromSlug(orgSlug);\n\n    const toType = (v: CreateProductDto['type']): ProductType => {\n      const s = String(v).toUpperCase();\n      if (s === 'PHYSICAL') return ProductType.PHYSICAL;\n      if (s === 'DIGITAL') return ProductType.DIGITAL;\n      if (s === 'SERVICE') return ProductType.SERVICE;\n      throw new BadRequestException(`Invalid product type: ${v}`);\n    };\n\n    const toStatus = (v: CreateProductDto['status']): ProductStatus => {\n      const s = String(v).toUpperCase();\n      if (s === 'ACTIVE') return ProductStatus.ACTIVE;\n      if (s === 'INACTIVE') return ProductStatus.INACTIVE;\n      throw new BadRequestException(`Invalid product status: ${v}`);\n    };\n\n    const sku =\n      dto.sku ??\n      `SKU-${Math.random().toString(36).slice(2, 7)}-${Math.floor(\n        Math.random() * 1_000_000,\n      )}`;\n\n    try {\n      const p = await this.prisma.product.create({\n        data: {\n          org: { connect: { id: orgId } },\n          title: dto.title,\n          type: toType(dto.type),\n          status: toStatus(dto.status),\n          price:\n            dto.price != null\n              ? new Prisma.Decimal(dto.price as any)\n              : null,\n          description: dto.description ?? null,\n          sku,\n        },\n        select: {\n          id: true,\n          orgId: true,\n          sku: true,\n          title: true,\n          type: true,\n          status: true,\n          price: true,\n          description: true,\n          inventoryQty: true,\n          createdAt: true,\n          updatedAt: true,\n        },\n      });\n      return this.serializeOne(p);\n    } catch (e: any) {\n      // Unique constraint (orgId, sku)\n      if (e?.code === 'P2002') {\n        throw new ConflictException(\n          'A product with this SKU already exists for this org',\n        );\n      }\n      throw e;\n    }\n  }\n\n  async update(orgSlug: string, id: string, dto: UpdateProductDto) {\n    const orgId = await this.getOrgIdFromSlug(orgSlug);\n\n    const coerceType = (\n      v: UpdateProductDto['type'],\n    ): ProductType | undefined => {\n      if (v == null) return undefined;\n      const s = String(v).toUpperCase();\n      if (s === 'PHYSICAL') return ProductType.PHYSICAL;\n      if (s === 'DIGITAL') return ProductType.DIGITAL;\n      if (s === 'SERVICE') return ProductType.SERVICE;\n      throw new BadRequestException(`Invalid product type: ${v}`);\n    };\n\n    const coerceStatus = (\n      v: UpdateProductDto['status'],\n    ): ProductStatus | undefined => {\n      if (v == null) return undefined;\n      const s = String(v).toUpperCase();\n      if (s === 'ACTIVE') return ProductStatus.ACTIVE;\n      if (s === 'INACTIVE') return ProductStatus.INACTIVE;\n      throw new BadRequestException(`Invalid product status: ${v}`);\n    };\n\n    try {\n      // ownership check (throws if not found or wrong org)\n      await this.ensureProductBelongsToOrg(id, orgId);\n\n      const p = await this.prisma.product.update({\n        where: { id },\n        data: {\n          title: dto.title ?? undefined,\n          type: coerceType(dto.type),\n          status: coerceStatus(dto.status),\n          price:\n            dto.price != null\n              ? new Prisma.Decimal(dto.price as any)\n              : undefined,\n          description:\n            dto.description !== undefined ? dto.description ?? null : undefined,\n          sku: dto.sku ?? undefined,\n        },\n        select: {\n          id: true,\n          orgId: true,\n          sku: true,\n          title: true,\n          type: true,\n          status: true,\n          price: true,\n          description: true,\n          inventoryQty: true,\n          createdAt: true,\n          updatedAt: true,\n        },\n      });\n      return this.serializeOne(p);\n    } catch (e: any) {\n      if (e?.code === 'P2002') {\n        throw new ConflictException(\n          'A product with this SKU already exists for this org',\n        );\n      }\n      throw e;\n    }\n  }\n\n  async remove(orgSlug: string, id: string) {\n    const orgId = await this.getOrgIdFromSlug(orgSlug);\n    await this.ensureProductBelongsToOrg(id, orgId);\n    await this.prisma.product.delete({ where: { id } });\n    return { ok: true };\n  }\n\n  async adjustInventory(orgSlug: string, id: string, delta: number) {\n    const orgId = await this.getOrgIdFromSlug(orgSlug);\n\n    return this.prisma.$transaction(async (tx: Prisma.TransactionClient) => {\n      const current = await tx.product.findFirst({\n        where: { id, orgId },\n        select: { id: true, inventoryQty: true },\n      });\n      if (!current) throw new NotFoundException('Product not found');\n\n      const nextQty = current.inventoryQty + delta;\n      if (nextQty < 0) throw new BadRequestException('Inventory cannot be negative');\n\n      const p = await tx.product.update({\n        where: { id },\n        data: { inventoryQty: nextQty },\n        select: {\n          id: true,\n          orgId: true,\n          sku: true,\n          title: true,\n          type: true,\n          status: true,\n          price: true,\n          description: true,\n          inventoryQty: true,\n          createdAt: true,\n          updatedAt: true,\n        },\n      });\n      return this.serializeOne(p);\n    });\n  }\n\n  /** Ensures the product belongs to org. */\n  private async ensureProductBelongsToOrg(id: string, orgId: string) {\n    const found = await this.prisma.product.findUnique({\n      where: { id },\n      select: { id: true, orgId: true },\n    });\n    if (!found) throw new NotFoundException('Product not found');\n    if (found.orgId !== orgId) {\n      throw new BadRequestException('Product does not belong to org');\n    }\n  }\n}"],"version":3}