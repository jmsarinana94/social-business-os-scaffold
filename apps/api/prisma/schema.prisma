// apps/api/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite" // uses DATABASE_URL from .env
  url      = env("DATABASE_URL")
}

//
// Enums
//
enum ProductType {
  PHYSICAL
  DIGITAL
}

enum ProductStatus {
  ACTIVE
  INACTIVE
}

//
// Models
//

model User {
  id          String       @id @default(cuid())
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  email       String       @unique

  // Expose as `passwordHash` in Prisma Client (your code selects this),
  // and also store in the db column `passwordHash`.
  passwordHash String      @map("passwordHash")

  lastLoginAt DateTime?

  // memberships to organizations
  memberships OrgMember[]

  @@map("User")
}

model Organization {
  id        String      @id @default(cuid())
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // your guards/tests resolve x-org to this slug
  slug      String      @unique
  name      String

  members   OrgMember[]
  products  Product[]

  @@map("Org")
}

model OrgMember {
  id        String        @id @default(cuid())
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  organizationId String
  userId         String
  role           String        @default("MEMBER")

  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@map("OrgMember")
}

model Product {
  id              String         @id @default(cuid())
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // relation expected by code as `product.organization`
  organizationId  String
  organization    Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // tests and services use `title`
  title           String

  // SKU unique within an org
  sku             String

  description     String?
  type            ProductType
  status          ProductStatus

  price           Decimal

  // inventory helpers used in e2e/services
  inventoryQty    Int            @default(0)
  lastPurchasedAt DateTime?

  @@unique([organizationId, sku])
  @@map("Product")
}